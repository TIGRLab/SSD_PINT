---
title: "checking completion"
output: 
  html_document:
    keep_md: TRUE
    toc : TRUE
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 


```{r}
library(tidyverse)

```

```{r reading_mriqc_bolds, message=FALSE, warning=FALSE}
sub_projects = c("ZHH", "COBRE", "ASDD", "ASDD", "DTI3T" , "RTMSWM", "PNSC", "SPINS", "ds000030_R1.0.5")

read_mriqc_bold <- function(studyname) {
  bold <- read_csv(str_c("../data/ciftify_fmriprep/", studyname, "/out/mriqc/bold.csv")) %>%
    mutate(subject_id = parse_character(subject_id))
  if ("session_id" %in% names(bold)) {
    bold <- bold %>% mutate(session_id = parse_character(session_id))
  }
  return(bold)
}

all_the_bolds <- tibble(studyname = sub_projects) %>% 
    mutate(boldqc = map(studyname, function(x) {
        read_mriqc_bold(x)
    })) %>%
    unnest() %>%
  filter(task_id == "rest") 

```
```{r}
all_the_bolds %>%
  select(subject_id, studyname) %>%
  distinct() %>%
  count()
```
```{r identify_pint_outputs}
pint_summarys_wses <- Sys.glob("../data/ciftify_fmriprep/*/out/ciftify_PINT/sub*/ses*/*summary.csv")

pint_summarys_nses <- Sys.glob("../data/ciftify_fmriprep/*/out/ciftify_PINT/sub*/*summary.csv")

pintdf_nses <- tibble(filepath = pint_summarys_nses) %>%
  separate(filepath,
           into = c('1','2','3','dataset','4','5','subid', 'filename'),
           sep = .Platform$file.sep) %>%
  select(dataset, subid, filename)

pintdf_wses <- tibble(filepath = pint_summarys_wses) %>%
  separate(filepath,
           into = c('1','2','3','dataset','4','5','subid', 'sessid', 'filename'),
           sep = .Platform$file.sep) %>%
  select(dataset, subid, sessid, filename)

pintdf <- bind_rows(pintdf_wses, pintdf_nses)

rm(pint_summarys_nses, pint_summarys_wses, pintdf_nses, pintdf_wses)
```

```{r}
bolds_condensed <- all_the_bolds %>%
  select(studyname, ends_with('_id'), starts_with('fd_'), starts_with('size'), starts_with('spacing')) %>%
  rename(dataset = studyname) %>%
  mutate(participant_id = str_c("sub-", subject_id),
         sessid = str_c("ses-",session_id)) 
```

```{r}
# removing session id column because it is redundant
simple_pheno <- read_csv('../phenotypic/simple_pheno_201809.csv') %>%
  select(-session_id)
```

```{r}
bolds_condensed %>%
  anti_join(simple_pheno, by = "participant_id") 
```



```{r}
bolds_condensed %>%
  inner_join(simple_pheno, by = c("participant_id", "dataset")) %>%
  select("participant_id", "dataset", "DX") %>%
  distinct() %>%
  count(DX)
```
```{r}
qa_passes_pheno <- bolds_condensed %>%
  inner_join(simple_pheno, by = c("participant_id", "dataset")) %>%
  filter(fd_mean < 0.5, fd_perc < 50) 
```


```{r}
anti_join(qa_passes_pheno, pintdf,
          by = c("dataset", "participant_id" = "subid", "sessid"))
```



```{r}
qa_passes_pheno %>%
  group_by(subject_id) %>%
  sample_n(1) %>%
  ungroup() %>%
  group_by(site, DX) %>%
  summarise(n = n(),
            nMale = sum(Sex == "M"),
            perc_male = nMale/n()*100,
            age_mean = mean(age, na.rm = T),
            age_sd = sd(age, na.rm = T),
            age_min = min(age, na.rm = T),
            age_max = max(age, na.rm = T))

```
```{r}
qa_passes_pheno %>%
  mutate(scan_length = size_t*2/60) %>%
  group_by(subject_id) %>%
  sample_n(1) %>%
  ungroup() %>%
  group_by(site, DX, size_t, size_x, size_y, size_z, spacing_tr, spacing_x, spacing_z, scan_length) %>%
  count()

```



```{r} 
qa_passes_pheno %>%
  select(-ends_with("_x"), -ends_with("_y")) %>%
  left_join(pintdf,
          by = c("dataset", "participant_id" = "subid", "sessid")) %>%
  write_csv('../phenotypic/20180918_pheno_qapass.csv')
           
```

+ ASDD has to rerun ciftify for 4 subs because the missing Results!
+ ZHH is done! (note that the TR for scans without a TR was set to 2s by Saba and Dayton)
+ RTMSWM is done!
+ PNSC (CMH0020 missing confounds file)
+ DTI3T is done!
+ SPINS has one extra bold (CMHAA2102 - from VIPR - disregard)
+ COBRE has issues..(two subs refuse to run)
+ ds00030 several subject need to rerun ciftify..
