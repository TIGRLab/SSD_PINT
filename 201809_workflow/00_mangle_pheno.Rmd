---
title: "Mangle the phenotypic data"
output: html_notebook
---

and now it starts

let's get some idea of what data we have

There are now Four/ish Center's sites from which we are pooling data for this project

+ CAMH data (pooling across ASDD, RTMSWM, PNSC, SPINS studies..)
+ COBRE data
+ CNP data
+ ZHH older data

For all sites we want:

+ the preprosessed data
+ the MRIQC metrics
+ scanner
+ age
+ sex
+ education
+ diagnosis

Additionally, we want to get an idea of the available:

+ medications
+ neurocognitive (esp executive function)
+ age of onset/ first episode vs not
+ negative symptoms?

## Starting with ZHH 

```{r}
library(foreign)
library(tidyverse)
library(readxl)
```

```{r}


ZHH_SZ = read.spss('../saba_pheno/Spreadsheets/ClinicalData/ZHH/Patient\ Sample\ 7-30-18.sav', to.data.frame=TRUE)
ZHH_CRTL = read.spss('../saba_pheno/Spreadsheets/ClinicalData/ZHH/Control Sample 7-30-18.sav', to.data.frame=TRUE)

qryHC_NewResting_15_40 <- read_excel("/KIMEL/tigrlab/external/miklos/demographics/qryHC_NewResting_15-40.xlsx")

```


Putting together the simplest stuff

```{r}

vars_from_both <- c("GRID", "SessNo","MRI_Date", "Age", "Sex", "DX", "Edu")

mangle_CTRL_ZHH <- qryHC_NewResting_15_40 %>%
  select(SessNo, sex) %>%
  right_join(ZHH_CRTL, by = "SessNo") %>%
  mutate(Sex = factor(sex, levels = c(1,2), labels = c("M", "F")),
         DX = "CTRL",
         Edu = EducatPtHighest) %>%
  select(one_of(vars_from_both))

mangle_SZ_ZHH <- ZHH_SZ %>%
  mutate(GRID = grid,
         Sex = factor(sex, levels = c("male", "female"), labels = c("M", "F")),
         DX = "SCZ",
         Edu = EducationPatient) %>%
  select(one_of(vars_from_both))

ZHH_pheno <-bind_rows(mangle_SZ_ZHH, mangle_CTRL_ZHH) %>%
  rename(age = Age) %>%
  mutate(participant_id = str_c('sub-',GRID),
         dataset = "ZHH")

rm(mangle_CTRL_ZHH, mangle_SZ_ZHH)

GRIDs_w_cerebellum_cutoff <- c(7793, 7834, 9405)
```

```{r}
cobre_participants <- read_delim("../data/ciftify_fmriprep/COBRE/COBRE/participants.tsv",
"\t", escape_double = FALSE, trim_ws = TRUE) %>%
  mutate(Sex = case_when( sex == "male" ~ "M",
                          sex == "female" ~ "F"),
         DX = case_when(dx == "Schizophrenia_Strict" ~ "SCZ",
                        dx == "Schizoaffective" ~ "SCZ",
                        dx == "No_Known_Disorder" ~ "CTRL"),
         dataset = "COBRE",
         participant_id = str_c('sub-', participant_id)) %>%
  select(participant_id, age, Sex, DX, dataset)

```

```{r}

ds00030_participants <- read_delim("../data/bids_in/ds000030/ds000030_R1.0.5/participants.tsv", 
    "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  filter(T1w != "n/a", rest != "n/a",
         diagnosis %in% c("CONTROL", "SCHZ")) %>%
  rename(Sex = gender) %>%
  mutate(DX = case_when(diagnosis == "CONTROL" ~ "CTRL",
                        diagnosis == "SCHZ" ~ "SCZ"),
         dataset = "ds000030_R1.0.5") %>%
  select(participant_id, age, DX, Sex, ScannerSerialNumber, ghost_NoGhost, dataset)

```

```{r}
old_pheno <- read_csv("../phenotypic/NEWallSubjects_completeData3_DM_not_sexmatched.csv")

CMH_pheno <- old_pheno %>% 
  filter(site == 1) %>%
  separate(subid, into = c("Study", "Site", "Subject", "session_id")) %>%
  unite(subject_id, Site, Subject, sep = "") %>%
  mutate(DX = case_when(DX_GROUP == 2 ~ "CTRL",
                        DX_GROUP == 1 ~ "SCZ"),
         Sex = case_when(sex.x == 1 ~ "M",
                         sex.x == 2 ~ "F"),
         dataset = case_when(Study == "SPN01" ~ "SPINS",
                             Study == "RTMSWM" ~ "RTMSWM",
                             Study == "ASDD" ~ "ASDD",
                             Study == "DTI" ~ "DTI3T",
                             Study == "PNS" ~ "PNSC"),
         participant_id = str_c("sub-", subject_id)) %>%
  select(participant_id, session_id, DX, age, Sex, dataset)

```

```{r}
simple_pheno = bind_rows(CMH_pheno,
                         ZHH_pheno,
                         ds00030_participants,
                         cobre_participants)
```


```{r}
write_csv(simple_pheno, "../phenotypic/simple_pheno_201809.csv")
```


## Note - re picking motion cutoffs

Based on our looking at the mriqc outputs, any visual QC issues are associated with high motion (mean fd > 0.6mm percent > 48%)

## Now looking at what we have from COBRE

```{r}
library(readr)
cobre_participants <- read_delim("/mnt/tigrlab/scratch/edickie/saba_PINT/ciftify_fmriprep/COBRE/COBRE/participants.tsv", 
    "\t", escape_double = FALSE, trim_ws = TRUE)

check_cobreness <- anti_join(filter(older_data, Site == "COBRE"), cobre_participants, by = c("name" = "participant_id"))
```


```{r}
cobre_mriqc <- 
```

From the COBRE data dictionary we see that:

+ CODEM_6: Highest Level of Education for Primary Caretaker until 18 years old
+ CODEM_7: Highest Level of Education for Secondary Caretaker until subject was 18 years old
+ There is also a smoking scale 
+ and hours of sleep night before scan
+ There is a medictions scale as well (COMED)
+ And a PANSS
+ Neuropsych includes the (CNP cols) WTAR, WASI, and Matrics..

## Now looking at the CNP we have..

+ wais, sans, medication, bprs, education, smoking status. cpt

## add where are is the CMH demographic info..

```{r}

```
```{r}
PNS_DATA_2018_07_16_1026 <- read_csv("/mnt/tigrlab/projects/saba/PINT_SCZ/new_analyses_20170412/Summer2018/Spreadsheets/ClinicalData/PNS/PNS_DATA_2018-07-16_1026.csv")


PNS_DATA_2018_07_16_1026$record_id

```
