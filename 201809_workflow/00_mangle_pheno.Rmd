---
title: "Mangle the phenotypic data"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: true
    df_print: paged
---

and now it starts

let's get some idea of what data we have

There are now Four/ish Center's sites from which we are pooling data for this project

+ CAMH data (pooling across ASDD, RTMSWM, PNSC, SPINS studies..)
+ COBRE data
+ CNP data
+ ZHH older data

For all sites we want:

+ the preprosessed data
+ the MRIQC metrics
+ scanner
+ age
+ sex
+ education
+ diagnosis

Additionally, we want to get an idea of the available:

+ medications
+ neurocognitive (esp executive function)
+ age of onset/ first episode vs not
+ negative symptoms?

## Starting with ZHH 

```{r}
library(foreign)
library(tidyverse)
library(readxl)
```

```{r}


ZHH_SZ = read.spss('../restricted_pheno/ZHH/phenotypic/Patient\ Sample\ 7-30-18.sav', to.data.frame=TRUE)
ZHH_CRTL = read.spss('../restricted_pheno/ZHH/phenotypic/Control Sample 7-30-18.sav', to.data.frame=TRUE)

qryHC_NewResting_15_40 <- read_excel("../restricted_pheno/ZHH/demographics/qryHC_NewResting_15-40.xlsx")
```


Putting together the simplest stuff

```{r}

vars_from_both <- c("GRID", "SessNo","MRI_Date", "Age", "Sex", "DX", "Edu")

mangle_CTRL_ZHH <- qryHC_NewResting_15_40 %>%
  select(SessNo, sex) %>%
  right_join(ZHH_CRTL, by = "SessNo") %>%
  mutate(Sex = factor(sex, levels = c(1,2), labels = c("M", "F")),
         DX = "CTRL",
         Edu = EducatPtHighest) %>%
  select(one_of(vars_from_both))

mangle_SZ_ZHH <- ZHH_SZ %>%
  mutate(GRID = grid,
         Sex = factor(sex, levels = c("male", "female"), labels = c("M", "F")),
         DX = "SSD",
         Edu = EducationPatient) %>%
  rename(isFEP = Type) %>%
  select(one_of(vars_from_both), isFEP)

ZHH_pheno <-bind_rows(mangle_SZ_ZHH, mangle_CTRL_ZHH) %>%
  rename(zhh_session_id = SessNo) %>%
  mutate(subject = str_c('sub-',GRID),
         dataset = "ZHH",
         Site = "ZHH",
         Scanner = "ZHH")

rm(mangle_CTRL_ZHH, mangle_SZ_ZHH)

GRIDs_w_cerebellum_cutoff <- c(7793, 7834, 9405)
```

## Coding ZHH data by session

When the ZHH data was converted to BIDS, we renamed the session ids in order. But the phenotypic data we have is coded by the original session ids. So lets map the original session ids to the ZHH data.

Note: looking at Dayton's scripts - he first joined the participants demographics witha list of what scans we have available.. then he sorted , within participant, by GRID session id and labeled those in orders (i.e 01, 02, 03 etc.)

```{r}
orig_rest_HC <- tibble(files = list.files('/external/miklos/raw/HC/rsfmri/')) %>% 
  separate(files, into = c('SessNo', 'therest') , sep = '_', extra = "merge")
orig_T1w_HC <- tibble(files = list.files('/external/miklos/raw/HC/struct/'))  %>% 
  separate(files, into = c('SessNo', 'therest') , sep = '_', extra = "merge")
orig_rest_SZ <- tibble(files = list.files('/external/miklos/raw/SCZ/rsfmri/'))  %>% 
  separate(files, into = c('SessNo', 'therest') , sep = '_', extra = "merge")
orig_T1w_SZ <- tibble(files = list.files('/external/miklos/raw/SCZ/struct/'))  %>% 
  separate(files, into = c('SessNo', 'therest') , sep = '_', extra = "merge")

orig_rest_both = bind_rows(orig_rest_HC, orig_rest_SZ)
orig_T1w_both = bind_rows(orig_T1w_HC, orig_T1w_SZ)

orig_both = inner_join(orig_rest_both, orig_T1w_both, by = "SessNo")
```

```{r}

```



```{r}
cobre_participants <- read_delim("../phenotypic/cobre_participants.tsv",
"\t", escape_double = FALSE, trim_ws = TRUE) %>%
  rename(Age = age) %>%
  mutate(Sex = case_when( gender == "male" ~ "M",
                          gender == "female" ~ "F"),
         DX = case_when(diagnosis == "Schizophrenia_Strict" ~ "SSD",
                        diagnosis == "Schizoaffective" ~ "SSD",
                        diagnosis == "No_Known_Disorder" ~ "CTRL"),
         dataset = "COBRE",
         Site = "COBRE",
         subject = str_c('sub-', subjectid),
         Scanner = "COBRE") %>%
  select(subject, Age, Sex, DX, dataset, Site, Scanner)
```



```{r}

ds00030_participants <- read_delim("../data/bids_in/ds000030/ds000030_R1.0.5/participants.tsv", 
    "\t", escape_double = FALSE, trim_ws = TRUE) %>%
  filter(T1w != "n/a", rest != "n/a",
         diagnosis %in% c("CONTROL", "SCHZ")) %>%
  rename(Sex = gender,
         subject = participant_id) %>%
  mutate(DX = case_when(diagnosis == "CONTROL" ~ "CTRL",
                        diagnosis == "SCHZ" ~ "SSD"),
         dataset = "ds000030_R1.0.5",
         Site = "ds000030",
         Scanner = str_c("ds000030", ScannerSerialNumber),
         Age = age) %>%
  select(subject, Age, DX, Sex, Scanner, ghost_NoGhost, dataset, Site)

```

```{r}
old_pheno <- read_csv("../phenotypic/NEWallSubjects_completeData3_DM_not_sexmatched.csv")

CMH_pheno <- old_pheno %>% 
  filter(site == 1) %>%
  separate(subid, into = c("Study", "Site", "SUBJ", "cmh_session_id")) %>%
  unite(subject_id, Site, SUBJ, sep = "") %>%
  mutate(DX = case_when(DX_GROUP == 2 ~ "CTRL",
                        DX_GROUP == 1 ~ "SSD"),
         Sex = case_when(sex.x == 1 ~ "M",
                         sex.x == 2 ~ "F"),
         dataset = case_when(Study == "SPN01" ~ "SPINS",
                             Study == "RTMSWM" ~ "RTMSWM",
                             Study == "ASDD" ~ "ASDD",
                             Study == "DTI" ~ "DTI3T",
                             Study == "PNS" ~ "PNSC"),
         subject = str_c("sub-", subject_id),
         Scanner = "CMH",
         Site = "CMH", 
         Age = age) %>%
  select(subject, cmh_session_id, DX, Age, Sex, dataset, Site, Scanner)

```

```{r}
simple_pheno = bind_rows(CMH_pheno,
                         ZHH_pheno,
                         ds00030_participants,
                         cobre_participants)
```


```{r}
write_csv(simple_pheno, "../phenotypic/simple_pheno_201811.csv")
```

```{r}
simple_pheno
```

## Note - re picking motion cutoffs

Based on our looking at the mriqc outputs, any visual QC issues are associated with high motion (mean fd > 0.6mm percent > 48%)

## Now looking at what we have from COBRE


From the COBRE data dictionary we see that:

+ CODEM_6: Highest Level of Education for Primary Caretaker until 18 years old
+ CODEM_7: Highest Level of Education for Secondary Caretaker until subject was 18 years old
+ There is also a smoking scale 
+ and hours of sleep night before scan
+ There is a medictions scale as well (COMED)
+ And a PANSS
+ Neuropsych includes the (CNP cols) WTAR, WASI, and Matrics..

## Now looking at the CNP we have..

+ wais, sans, medication, bprs, education, smoking status. cpt

## add where are is the CMH demographic info..

----

## extra little bit for traking down "missing" COBRE

```{r include=FALSE}
cobre_test <- cobre_participants %>%
  mutate(name = str_replace(subject, 'sub-',''))
old_pheno %>% 
  filter(site==3) %>%
  anti_join(cobre_test, by = "name") #%>%
  #write_csv('/scratch/edickie/COBRE_participant_not_in_recent_download.csv')
```

```{r include=FALSE}
library(readxl)
COBRE_Data_Dictionary <- read_excel("../restricted_pheno/COBRE/COBRE_Data_Dictionary.xlsx", sheet = "COBRE Data Dictionary") 

COBRE_Data_Dictionary %>%
  slice(2000:3000)
```

```{r include=FALSE}
library(readr)

schizconnect_COBRE_assessmentData_2963 <- read_csv("../restricted_pheno/COBRE/schizconnect_COBRE_assessmentData_2963.csv",
col_types = cols(question_value = col_character()))


schizconnect_COBRE_assessmentData_2963
```
```{r include=FALSE}
cobre_participants <- read_csv("../restricted_pheno/COBRE/schizconnect_COBRE_assessmentData_2963.csv",
col_types = cols(question_value = col_character())) %>%
  filter(str_detect(question_id, "CODEM") | question_id == "SCIDII_01") %>%
  select(subjectid, site, question_id, question_value) %>%
  distinct() %>%
  spread(question_id, question_value) %>%
  select(subjectid, site, starts_with('CODEM'), SCIDII_01) %>%
  mutate(Age = parse_number(CODEM_1),
         Sex = case_when(CODEM_2 == "Male" ~ "M",
                         CODEM_2 == "Female" ~"F"),
         dataset = "COBRE",
         Site = site,
         Scanner = site,
         subject = str_c("sub-", subjectid),
         DX = case_when(str_detect(SCIDII_01, "29") ~ "SSD",
                        CODEM_16 == "19" ~ "SSD",
                        str_detect(SCIDII_01, "NONE") ~ "CTRL",
                        str_detect(SCIDII_01, "none") ~ "CTRL",
                        str_detect(SCIDII_01, "None") ~ "CTRL",
                        TRUE ~ "CTRL")) %>%
 select(subject, Age, Sex, DX, dataset, Site, Scanner) 
                        
```



