---
title: "Whole Connectome Stats"
output:
  html_document:
    keep_md: true
---

We are now going to see if there is anything in cortical-cortical connectivity by running the matrix of all possible connections instead of just subcortical-cortical stats. 

```{r message=FALSE, warning=FALSE}
library(tidygraph)
library(tidyverse)
library(broom)
library(knitr)
library(tableone)
library(cowplot)
library(igraph)
library(ggraph)
```

## The paths to data

```{r setting paths}
output_base <- '../data/ciftify_fmriprep/'

Yeo7_2011_80verts <- read_csv("../templates/Yeo7_2011_80verts.csv",
                              col_types = c(
                                hemi = col_character(),
                                tvertex = col_integer(),
                                LRpairs = col_integer(),
                                roiidx = col_integer(),
                                NETWORK = col_integer(),
                                LOBE = col_character(),
                                SHORTNAME = col_character(),
                                x = col_integer(),
                                y = col_integer(),
                                z = col_integer()
                              ))

YeoNet_colours = list("VI" = "#781286",
                      "SM" = "#4682B4",
                      "DA" = "#00760E", 
                      "VA" = "#C43AFA",
                      "DM" = "#CD3E3A", 
                      "FP" = "#E69422")

pheno <- read_csv('../phenotypic/20181118_pheno_qapass.csv') %>%
  drop_na(DX)
```

# Code for reading in all the timeseries..


A table that describes the current expected subortical files

```{r define-subcotical-files}
# a tibble table to specify the subcortical meants files that were generated
YeoNet_subcort_list <- c('VI','SM','DA','VA', 'LI','FP','DM')
```

```{r}
YeoNet7 <- tribble(
  ~network, ~hexcode,
  "VI", "#781286",
  "SM", "#4682B4",
  "DA", "#00760E",
  "VA", "#C43AFA",
  "FP", "#E69422",
  "DM", "#CD3E3A",
  "LI", "#dcf8a4")
```



These functions are for reading timeseries files

```{r subcortical file reading functions}

#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double()))
   return(meants)
}

#' Read the contents of a csv generated by PINT
#'
#' @param outputprefix The prefix to the PINT outputs
#' @param vertex_type "pvertex" or "tvertex"
#' @param projectname the outputdir
#' @param output_dir the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_pint_meants <- function(outputprefix, vertex_type, projectname, output_dir) {
  expected_filepath <- file.path(output_dir, projectname, "out",'ciftify_PINT', 
                           str_c(outputprefix, '_desc-clean_bold_', 
                                 vertex_type, '_meants.csv'))
  meants = read_meants_csv(expected_filepath) %>% t() %>% as.data.frame()
  names(meants) = Yeo7_2011_80verts$SHORTNAME
  return(meants)
}

#' Read the contents of a csv generated by PINT coord volume spheres
#'
#' @param outputprefix The prefix to the PINT outputs
#' @param projectname the outputdir
#' @param output_dir the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_pint_volsphere_meants <- function(outputprefix, projectname, output_dir) {
  expected_filepath <- file.path(output_dir, projectname, "out",'ciftify_meants', 
                           str_c(outputprefix, '_desc-volcleansm8_atlas-6mmYeo780_timeseries.csv'))
  meants = read_meants_csv(expected_filepath) %>% t() %>% as.data.frame()
  names(meants) = Yeo7_2011_80verts$SHORTNAME
  return(meants)
}

#' Read the contents of a subcortical csv
#' expample file path is sub-CMHHEF011_ses-01_task-rest_acq-CMH_run-01_bold_desc-cleansm0_atlas-7RSN_roi-Lcerebellum_timeseries.csv
#'
#' @param outputprefix the prefix to the pint outputfile
#' @param hemi The hemisphere "L" or "R"
#' @param subregion region "thalamus", "stiatum", "cerebellum"
#' @param output_dir the basepath of the output data
#' @param projectname the project name inside the output dir
#'
#' @return a dataframe of the _meants.csv contents
read_subcortical_hemi_meants <- function(outputprefix, hemi, subregion, projectname, output_dir) {
  expected_filepath <- file.path(output_dir, projectname, "out",'ciftify_meants', 
                           str_c(outputprefix,
                                 '_desc-cleansm0_atlas-7RSN_roi-', 
                                 hemi, subregion, '_timeseries.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}

#' Contructs the expected output prefix from subid session and func_base
#'
#' @param subid The subject identifier
#' @param sessid The session identifier (or null)
#' @param func_base The functional file prefix
#'
#' @return an output prefix string for the filenames
construct_output_prefix <- function(subid, sessid, func_base) {
  prefix <- if_else(is.na(sessid),
                    file.path(subid, str_c(subid, '_', func_base)),
                    file.path(subid, sessid, 
                      str_c(subid, '_', sessid, '_', func_base)))
  return(prefix)
}

#' get func_base from pint summary filename
#'
#' @param subid The subject identifier
#' @param sessid The session identifier (or null)
#' @param func_base The functional file prefix
#'
#' @return an output prefix string for the filenames
get_func_base_from_pint_summary_filename <- function(filename, subject, session) {
  func_base <- if_else(is.na(session), 
                       filename %>%
                         str_replace(str_c(subject, "_"), '') %>%
                         str_replace('_desc-clean_bold_summary.csv',''),
                       filename %>%
                         str_replace(subject, '') %>%
                         str_replace(session, '') %>% 
                         str_replace('__','') %>%
                         str_replace('_desc-clean_bold_summary.csv',''))
  return(func_base)
}

```


This reads all files and generate PINT to subcortical correlation values for a given subject

```{r read and correlated function}

the_subcortical_guide <- tribble(
 ~subcort_hemi, ~subcort_ROI, ~subcort_NET,
 "L", "thalamus", c('VI','SM','DA','VA', 'FP','DM'),
 "L", "striatum", c('SM','DA','VA', 'LI','FP','DM'),
 "L", "cerebellum", c('VI','SM','DA','VA', 'LI','FP','DM'),
 "R", "thalamus", c('VI','SM','DA','VA', 'LI','FP','DM'),
 "R", "striatum", c('VI','SM','DA','VA', 'LI','FP','DM'),
 "R", "cerebellum", c('VI','SM','DA','VA', 'LI','FP','DM')) %>%
  unnest() %>%
  unite(combined_name, subcort_hemi:subcort_NET, remove = FALSE)



#' read all fMRI timeseries data for one subject and correlates PINT ROIs with subcortex
#'
#' @param out_prefix the prefix to the pint outputfile
#' @param outputbase the path to the pint output directory
#' @param projectname the path to sub-study project (dataset)
#' @param Yeo7_2011_80verts as data frame describing the PINT ROIs 
#'
#' @return a dataframe (graph style) of PINT ROI to subcortical correlations
read_concat_subject_subcort <- function(out_prefix, projectname) {
  
  # read the subcortical meants files
  thalamus_L_meants <- read_subcortical_hemi_meants(out_prefix,
                                                    "L","thalamus", 
                                                    projectname, output_base)
  striatum_L_meants <- read_subcortical_hemi_meants(out_prefix,
                                                    "L","striatum",
                                                    projectname, output_base)
  cerebellum_L_meants <- read_subcortical_hemi_meants(out_prefix,
                                                      "L", "cerebellum",
                                                      projectname, output_base)
  thalamus_R_meants <- read_subcortical_hemi_meants(out_prefix,
                                                    "R","thalamus",
                                                    projectname, output_base)
  striatum_R_meants <- read_subcortical_hemi_meants(out_prefix,
                                                    "R","striatum", 
                                                    projectname, output_base)
  cerebellum_R_meants <- read_subcortical_hemi_meants(out_prefix,
                                                      "R", "cerebellum", 
                                                      projectname, output_base)
  
  # prepare to bind
  subcort_meants <- bind_rows(thalamus_L_meants, striatum_L_meants, cerebellum_L_meants,
                              thalamus_R_meants, striatum_R_meants, cerebellum_R_meants)
  
  # create file names
  subcort_meants_t <- t(subcort_meants) %>% as.data.frame()
  # note that the_subcortical_guide is in the global env
  names(subcort_meants_t) <- the_subcortical_guide$combined_name
  
  return(subcort_meants_t)
}  

#' binds subcortical to cortical timeseries and calculates graph
#'
#' @param subcort_meants 
#' @param pint_meants 
#'
#' @return a dataframe with to and from edgenames as well as Z transformed correlation
calc_PINT_plus_subcort_cor_df <- function(subcort_meants, pint_meants) {
  result <- bind_cols(pint_meants, subcort_meants) %>%
    cor() %>%
    atanh() %>%
    graph_from_adjacency_matrix(mode="upper", 
                                   weighted=T, diag=F) %>%
    as_data_frame()
  return(result)
}


#' reads in all the timeseries files for one participant
#' note that Yeo&_2011_80verts and output_base are pulled from the global env
run_read_all_subject_timeseries_and_corZ <- function(out_prefix, projectname) {
  # read the pint meants files
  pvertex_meants <- read_pint_meants(out_prefix, 'pvertex', 
                                     projectname, output_base)
  tvertex_meants <- read_pint_meants(out_prefix, 'tvertex',
                                     projectname, output_base)
  volsphere_meants <- read_pint_volsphere_meants(out_prefix,
                                                 projectname, output_base)
  # read the subcortical ROIs
  subcort_meants <-read_concat_subject_subcort(out_prefix, projectname)
  
  # calc edgewise correlations
  result <- bind_rows("pvertex" = calc_PINT_plus_subcort_cor_df(subcort_meants, pvertex_meants),
                      "tvertex" = calc_PINT_plus_subcort_cor_df(subcort_meants, tvertex_meants),
                      "tvolume" = calc_PINT_plus_subcort_cor_df(subcort_meants, volsphere_meants),
                      .id = "vertex_type")
  return(result)
}

# run_read_subject_subcort_corrs(subcort_outputlist$subid[1])

```

```{r}
read_vx_count <- function(filepath) {
  read_csv(filepath, col_names = FALSE) %>%
    mutate(network = c('VI','SM','DA','VA', 'LI','FP','DM')) 
}

vx_counts <- the_subcortical_guide %>%
  select(subcort_hemi, subcort_ROI) %>%
  distinct() %>%
  mutate(vx_count = str_c('../data/ciftify_fmriprep/ZHH/out/ciftify_meants/templates/7RSN_roi-',subcort_hemi, subcort_ROI,'_vxcount.txt')) %>%
mutate(vxnum = map(vx_count, ~read_vx_count(.x))) %>%
  unnest() %>%
  select(subcort_hemi, subcort_ROI, X1, network) %>%
  rename(numvx = X1)

write_csv(vx_counts, '../templates/subcort_vxcounts.csv')
```
```{r}
subcort_vxcounts <- read_csv("../templates/subcort_vxcounts.csv") %>%
  unite(combined_name, subcort_hemi, subcort_ROI, network, sep = "_") %>%
  mutate(size_is_ok  = if_else(numvx > 34, "yes", "no"))

the_subcortical_guide <- the_subcortical_guide %>%
  inner_join(subcort_vxcounts, by = "combined_name")
```


```{r}
node_annotations <- tibble(node_name = c(Yeo7_2011_80verts$SHORTNAME,
                                         the_subcortical_guide$combined_name)) %>%
  left_join(the_subcortical_guide, by = c("node_name" = "combined_name")) %>%
  mutate_if(is.character, funs(replace(., is.na(.), ''))) %>%
  mutate(etype = if_else(str_sub(node_name,2,2)=="_","SubCort", "Cort")) %>%
  mutate(cort_NET = if_else(etype == "Cort", str_sub(.$node_name, 1,2), ""),
         cort_hemi = if_else(etype == "Cort", str_sub(.$node_name, 5,5), ""),
         cort_lobe = if_else(etype == "Cort", str_sub(.$node_name, 3,3), ""),
         network = if_else(etype == "Cort", cort_NET, subcort_NET),
         network = factor(network, levels = rev(YeoNet7$network)),
         hemi = if_else(etype == "Cort", cort_hemi, subcort_hemi),
         size_is_ok = if_else(etype == "Cort", "yes", size_is_ok),
         subregion = if_else(etype == "Cort", cort_lobe, subcort_ROI),
         subregion = recode(subregion,
                            F = "Fron", P = "Pari", I = "Insul", T = "Tempo", O = "Occip",
                            thalamus = "Thal", cerebellum = "Cblm", striatum = "Stria"),
         subcort_ROI = factor(subcort_ROI, levels = c("striatum", "thalamus", "cerebellum"))) 

node_annotations <- node_annotations %>%
  filter(size_is_ok == "yes") %>%
  arrange(etype, subcort_ROI, network, subregion, hemi) %>%
  mutate(basic_rank = c(1:n()),
         etype_rank = (dense_rank(etype) - 1),
         subcort_rank =  dense_rank(subcort_ROI) %>% replace_na(0),
         custom_order = basic_rank  + etype_rank*10 + subcort_rank*5,
         custom_order = max(custom_order) - custom_order) %>%
  select(-basic_rank, -etype_rank, -subcort_rank)

node_annotations
```



### This reads all the subcortical files it can find

Write a func_base and outputprefix cols into the pheno file for the file reading step

```{r}
pheno <- pheno %>%
  mutate(func_base = get_func_base_from_pint_summary_filename(filename,subject, session), 
         outputprefix = construct_output_prefix(subject, session, func_base)) 
```

```{r eval = FALSE}
safely(map2(pheno$outputprefix, pheno$dataset,
                              ~run_read_all_subject_timeseries_and_corZ(.x, .y)))
```


```{r read all the data}

all_corZ_results <- pheno %>%
  select(subject, outputprefix, dataset) %>%
  mutate(the_corrs = map2(.$outputprefix, .$dataset,
                              ~run_read_all_subject_timeseries_and_corZ(.x, .y)))
```

### merge with the phenotypic data

```{r merge with pheno and clean}
results_pheno <- all_corZ_results %>%
  inner_join(pheno, by = "subject") %>%
  unnest() # %>%
  # mutate(YeoNet = str_sub(PINT_ROI, 1,2),
  #        hemisphere = str_sub(PINT_ROI, 5,5)) %>%
  # mutate(conn_type = if_else(YeoNet == subcort_NET, "same_net", "diff_net"),
  #        YeoNet = factor(YeoNet, levels = c("VI", "SM", "DA", "VA", "FP", "DM")),
  #        subcort_NET = factor(subcort_NET, levels = c("VI", "SM", "DA", "VA", "FP", "DM", "LI"))) %>%
  # select(subject, PINT_ROI, subcort_ROI, subcort_NET,subcort_hemi, 
  #        pvertex_corr, tvertex_corr, 
  #        DX, Sex, fd_mean, Age, Site, Scanner, Age_pt, fd_mean_pt,  
  #        YeoNet, hemisphere, conn_type) 

```


```{r eval = FALSE}
results_pheno
```

```{r}
DX_lm_model_full <- results_pheno %>%
  semi_join(node_annotations, by = c("to"="node_name")) %>%
  semi_join(node_annotations, by = c("from"="node_name")) %>%
  mutate(corZ = weight) %>%
  group_by(vertex_type, to, from) %>%
  do(tidy(lm(corZ ~ DX + Age_pt + Sex + fd_mean_pt + Scanner,.))) 
```


```{r}
annotated_graph_edges <- DX_lm_model_full %>%
  ungroup() %>%
  select(to, from) %>%
  distinct() %>%
  mutate(row_number = row_number()) %>%
  gather(edge_type, edgename, to, from) %>%
  left_join(the_subcortical_guide, by = c("edgename" = "combined_name")) %>%
  mutate_if(is.character, funs(replace(., is.na(.), ''))) %>%
  mutate(etype = if_else(str_sub(edgename,2,2)=="_","SubCort", "Cort")) %>%
  mutate(cort_NET = if_else(etype == "Cort", str_sub(.$edgename, 1,2), ""),
         cort_hemi = if_else(etype == "Cort", str_sub(.$edgename, 5,5), ""),
         cort_lobe = if_else(etype == "Cort", str_sub(.$edgename, 3,3), "")) %>%
  gather(e_col, e_val, edgename, subcort_hemi:cort_lobe) %>%
  unite(e_tcol, edge_type, e_col) %>%
  spread(e_tcol, e_val) %>%
  unite(from_to_type, from_etype, to_etype) %>%
  unite(hemis, from_subcort_hemi, from_cort_hemi, to_subcort_hemi, to_cort_hemi, sep = "") %>%
  unite(networks, from_subcort_NET, from_cort_NET, to_subcort_NET, to_cort_NET, sep = "", remove = FALSE) %>%
  mutate(from_to_type = recode(from_to_type, "Cort_SubCort" = "SubCort_Cort")) %>%
  mutate(hemis = recode(hemis, "RL" = "LR")) %>%
  mutate(to = to_edgename, from = from_edgename)
```

```{r}
DX_lm_model <- DX_lm_model_full %>%
  ungroup() %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(withinsubcort = if_else((from_to_type == "SubCort_SubCort") & (from_subcort_ROI == to_subcort_ROI), "drop", "keep")) %>%
  filter(withinsubcort == "keep") %>%
  select(vertex_type, to, from, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)
```



```{r}
DX_lm_model %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(sig_edge = if_else(p_FDR < 0.05, "sig", "ns"),
         stat_pos = if_else(statistic > 0, "pos", "neg")) %>%
  filter(term == "DXSSD") %>% 
  count(vertex_type, from_to_type, sig_edge) %>%
  spread(sig_edge, n) %>%
  mutate(perc_sig = sig/(ns + sig)*100)

```
```{r}
DX_lm_model %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(cort_networks = str_c(to_cort_NET, from_cort_NET)) %>%
  filter(term == "DXSSD", p_FDR < 0.05) %>% 
  count(vertex_type, from_to_type, cort_networks) %>%
  spread(vertex_type, n, fill = 0) %>%
  mutate(vert_diff = pvertex - tvertex) %>%
  arrange(from_to_type, -abs(vert_diff))
```
```{r}
DX_lm_model %>% count(term)
```
```{r}
subcort_rn <- the_subcortical_guide %>%
  arrange(subcort_ROI, subcort_NET) %>%
  select(combined_name)
```



```{r}
#' convert from three col graph df to adjacency matrix
uppertri_df_to_agjmat <- function(graph_df) {
  
names(graph_df) <- c('to', 'from', 'myattr')
matrix_out <- graph_df %>%
  graph_from_data_frame(.,directed = F) %>%
  get.adjacency(., type = "both", attr = "myattr") %>%
  as.matrix() 
return(matrix_out)
}

#' go uppertri data to full dataframe for geom_tile
uppertri_df_to_full <- function(graph_df) {
result <- graph_df %>%
  uppertri_df_to_agjmat() %>%
  as.data.frame() %>%
  mutate(to = row.names(.)) %>%
  gather(from, value, -to) 
return(result)
}
```




```{r fig.height=20, fig.width= 12}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
  ungroup() %>%
  select(vertex_type, to, from, statistic) %>%
  group_by(vertex_type) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  mutate(to_lab = factor(to, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name),
         from_lab = factor(from, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name)) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1) +
  labs(title = "T statistic for effect of DX",
       x = NULL, y = NULL, fill = "T statistic for DX")
```
```{r fig.height=20, fig.width= 12}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
  mutate(t_filtered = if_else(p_FDR < 0.1, statistic, 0)) %>%
  ungroup() %>%
  select(vertex_type, to, from, t_filtered) %>%
  group_by(vertex_type) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  mutate(to_lab = factor(to, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name),
         from_lab = factor(from, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name)) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1) +
  labs(title = "T statistic for effect of DX (thesholded)",
       x = NULL, y = NULL, fill = "T statistic for DX")
```
```{r fig.height=20, fig.width= 12}
mean_cors <- results_pheno %>%
  mutate(corZ = weight) %>%
  group_by(vertex_type, to, from) %>%
  summarise(mcorZ = mean(corZ))

mean_cors %>%
  ungroup() %>%
  select(vertex_type, to, from, mcorZ) %>%
  group_by(vertex_type) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  mutate(to_lab = factor(to, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name),
         from_lab = factor(from, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name)) %>%
  filter(to %in% Yeo7_2011_80verts$SHORTNAME) %>%
  filter(from %in% Yeo7_2011_80verts$SHORTNAME) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1) +
  labs(title = "edgewise mean cor (Z)",
       x = NULL, y = NULL, fill = "correlation (Z)")
```
```{r}
mean_cors %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(within_between = if_else(from_cort_NET == to_cort_NET, "within", "between")) %>%
  filter(within_between == "within") %>%
  ggplot(aes(x = mcorZ, fill = vertex_type)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~from_cort_NET)
```
```{r}
113.1*2.6/2^3
```
```{r}
904.78/2^3
```


```{r super-cools-plot-function}

make_super_cools_plot <- function(lm_df, pos_label, neg_label, plot_title) {
  lm_df <- lm_df %>%
    mutate(effect_cat = case_when(p_FDR < 0.05 & statistic < 0 ~ "neg",
                              p_FDR < 0.05 & statistic > 0 ~ "pos",
                              p_FDR > 0.05 ~ "ns")) 

tg_lm <- as_tbl_graph(lm_df) %>%
  activate(nodes) %>%
  left_join(node_annotations, by = c("name" = "node_name")) %>%
  filter(size_is_ok == "yes") %>%
  activate(edges) %>%
  filter(effect_cat != "ns") %>%
  mutate(effect_cat = factor(effect_cat, 
                               levels = c("pos","neg"),
                               labels = c(pos_label, neg_label)))

plt <- ggraph(tg_lm, layout = 'linear', circular = FALSE, 
       sort.by = "custom_order", use.numeric = TRUE,
       offset = pi) +
  geom_edge_arc(aes(color = effect_cat, 
                    width = abs(statistic), 
                    alpha = abs(statistic))) +
  geom_node_point(aes(color = network), size = 2) +
  scale_color_manual(values = rev(YeoNet7$hexcode)) +
  coord_flip() +
  theme_minimal() +
  theme(panel.border = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        axis.line = element_blank(),
        axis.text.x  = element_blank(),
        axis.text.y  = element_blank()) +
  labs(title = plot_title, x = NULL, y = NULL, 
       color = "RSN Network", edge_color = "p < 0.05")
  return(plt)
}

```





```{r}
current_cortcort <- DX_lm_model %>%
  ungroup() %>%
  select(to, from) %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name")) %>%
  filter(etype.x == "Cort", etype.y == "Cort") %>%
  select(network.x, network.y) %>%
  distinct() 
new_mat <- current_cortcort %>%
  mutate(val = 1) %>%
  uppertri_df_to_agjmat() 
ym <- YeoNet7$network[2:7]
new_mat <- new_mat[order(ym),order(ym)]
gm<- graph_from_adjacency_matrix(new_mat, mode = "upper") 
new_order <- as_data_frame(gm)
flipping_guide <- left_join(current_cortcort, mutate(new_order, thing = 1), by = c("network.x" = "from", "network.y" = "to")) %>%
  mutate(flip_order = if_else(is.na(thing), "yes", "no"),
         etype.x = "Cort",
         etype.y = "Cort") %>%
  select(-thing)
flip_subcort <- DX_lm_model %>%
  ungroup() %>%
  select(to, from) %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name")) %>%
  filter(etype.x == "SubCort", etype.y == "SubCort") %>%
  select(hemi.x, hemi.y, subcort_ROI.x, subcort_ROI.y) %>%
  distinct() %>%
  mutate(drop_rows = if_else(subcort_ROI.x == subcort_ROI.y, "drop", "keep"),
         flip_order2 = if_else(subcort_ROI.x == "cerebellum" & subcort_ROI.y == "thalamus", "yes", "no"),
         flip_order2 = if_else(subcort_ROI.x == "cerebellum" & subcort_ROI.y == "striatum", "yes", flip_order2),
         flip_order2 = if_else(subcort_ROI.x == "thalamus" & subcort_ROI.y == "striatum", "yes", flip_order2))

```

```{r}
flip_DX_model <- DX_lm_model %>%
  ungroup() %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name")) %>%
  mutate(network.x = as.character(network.x),
         network.y = as.character(network.y)) %>%
  left_join(flipping_guide, by = c("network.x", "network.y", 'etype.x', 'etype.y')) %>%
  mutate(flip_order = replace_na(flip_order, "no")) %>%
  left_join(flip_subcort, by = c('hemi.x', 'hemi.y','subcort_ROI.x','subcort_ROI.y')) %>%
  mutate(flip_order2 = replace_na(flip_order2, "no"),
         drop_rows = replace_na(drop_rows, "no"),
         flip_order = if_else(flip_order2 == "yes", "yes", flip_order)) %>%
  mutate(nto = if_else(flip_order == "yes", from, to),
         nfrom = if_else(flip_order == "yes", to, from)) %>%
  select(-to, -from) %>%
  rename(to = nto, from = nfrom) %>%
  filter(drop_rows != "drop") %>%
  select(to, from, term, vertex_type, statistic, p_FDR)
```

```{r eval = FALSE}
flipping_guide$flip_order[flipping_guide$network.x=="VA" & flipping_guide$network.y == "DA"] <- "no"
flipping_guide$flip_order[flipping_guide$network.x=="VI" & flipping_guide$network.y == "SM"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="SM" & flipping_guide$network.y == "VA"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="VI" & flipping_guide$network.y == "VA"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="DM" & flipping_guide$network.y == "DA"] <- "no"
flipping_guide$flip_order[flipping_guide$network.x=="SM" & flipping_guide$network.y == "DM"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="SM" & flipping_guide$network.y == "DA"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="VI" & flipping_guide$network.y == "FP"] <- "yes"
flipping_guide$flip_order[flipping_guide$network.x=="SM" & flipping_guide$network.y == "FP"] <- "yes"
flipping_guide
```



```{r}
flip_subcort <- DX_lm_model %>%
  ungroup() %>%
  select(to, from) %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name")) %>%
  filter(etype.x == "SubCort", etype.y == "SubCort") %>%
  select(hemi.x, hemi.y, subcort_ROI.x, subcort_ROI.y) %>%
  distinct() %>%
  mutate(drop_rows = if_else(subcort_ROI.x == subcort_ROI.y, "drop", "keep"),
         flip_order2 = if_else(subcort_ROI.x == "thalamus" & subcort_ROI.y == "cerebullum", "yes", "no"))
```

```{r}
flip_subcort %>% filter(drop_rows == "keep")
```


```{r}
flip_DX_model <- DX_lm_model %>%
  ungroup() %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name")) %>%
  mutate(network.x = as.character(network.x),
         network.y = as.character(network.y)) %>%
  left_join(flipping_guide, by = c("network.x", "network.y", 'etype.x', 'etype.y')) %>%
  mutate(flip_order = replace_na(flip_order, "no")) %>%
  left_join(flip_subcort, by = c('hemi.x', 'hemi.y','subcort_ROI.x','subcort_ROI.y')) %>%
  mutate(flip_order2 = replace_na(flip_order2, "no"),
         drop_rows = replace_na(drop_rows, "no"),
         flip_order = if_else(flip_order2 == "yes", "yes", flip_order)) %>%
  mutate(nto = if_else(flip_order == "yes", from, to),
         nfrom = if_else(flip_order == "yes", to, from)) %>%
  select(-to, -from) %>%
  rename(to = nto, from = nfrom) %>%
  filter(drop_rows != "drop") %>%
  select(to, from, term, vertex_type, statistic, p_FDR)
```

```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "DXSSD") %>%
  filter(vertex_type == "pvertex") %>%
  make_super_cools_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Personalized")
```
```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "DXSSD") %>%
  filter(vertex_type == "tvertex") %>%
  make_super_cools_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Template")
```

```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "DXSSD") %>%
  filter(vertex_type == "tvolume") %>%
  make_super_cools_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Template")
```

```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "Age_pt") %>%
  filter(vertex_type == "pvertex") %>%
  make_super_cools_plot(pos_label = "Age Increase", 
                      neg_label = "Age Decrease",
                      plot_title = "Personalized")
```
```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "fd_mean_pt") %>%
  filter(vertex_type == "pvertex") %>%
  make_super_cools_plot(pos_label = "+ corrlation with motion", 
                      neg_label = "- corrlation with motion",
                      plot_title = "Personalized")
```

```{r fig.height=10, fig.width=10}
flip_DX_model %>%
  filter(term == "fd_mean_pt") %>%
  filter(vertex_type == "tvertex") %>%
  make_super_cools_plot(pos_label = "+ corrlation with motion", 
                      neg_label = "- corrlation with motion",
                      plot_title = "Template")
```

```{r fig.height=12, fig.width= 12}
full_DX_mat <- DX_lm_model %>%
  filter(term == "DXSSD", vertex_type == "pvertex") %>%
  ungroup() %>%
  select(to, from, statistic) %>%
  uppertri_df_to_full() 

full_DX_mat %>%
  mutate(to_lab = factor(to, levels = node_annotations$node_name), 
         from_lab = factor(from, levels = node_annotations$node_name)) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "T statistic for effect of DX",
       x = NULL, y = NULL, fill = "T statistic for DX")
```

```{r}
hypo_cerebullum_to_striatum <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(subcort_ROI.x == "cerebellum") %>%
    filter(subcort_ROI.y == "striatum") %>%
    filter(value < -2) %>%
    select(to, from, value)

hyper_subcort_to_SMVI <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("VI", "SM")) %>%
    filter(value > 2) %>%
    select(to, from, value)

hyper_subcort_to_DM <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("DM")) %>%
    filter(value > 2) %>%
    select(to, from, value)

hypo_subcort_to_FPVA <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("FP","VA")) %>%
    filter(value < -2) %>%
    select(to, from, value)

hyper_cortSM_to_FPDA <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("SM")) %>%
    filter(as.character(network.y) %in% c("FP","DA")) %>%
    filter(value > 2) %>%
    select(to, from, value)

hyper_cortVA_to_DAVI <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("SM")) %>%
    filter(as.character(network.y) %in% c("FP","VA")) %>%
    filter(value > 2) %>%
    select(to, from, value)

hyper_cortVADA_to_SMVI <- bind_rows(hyper_cortSM_to_FPDA,
                                    hyper_cortVA_to_DAVI)

hypo_cortDM_to_DAVA <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("DM")) %>%
    filter(as.character(network.y) %in% c("DA","VA")) %>%
    filter(value < -2) %>%
    select(to, from, value)

hypo_cortDM_to_SM <- full_DX_mat %>%
    inner_join(node_annotations, by = c("to"="node_name")) %>%
    inner_join(node_annotations, by = c("from"="node_name")) %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("SM")) %>%
    filter(as.character(network.y) %in% c("DM")) %>%
    filter(value < -2) %>%
    select(to, from, value)

hypo_cortDM_to_DAVASM <- bind_rows(hypo_cortDM_to_DAVA, hypo_cortDM_to_SM)

Fz_weigths <-bind_rows(hypo_cortDM_to_DAVASM = hypo_cortDM_to_DAVASM,
                       hyper_cortVADA_to_SMVI = hyper_cortVADA_to_SMVI,
                       hyper_subcort_to_DM = hyper_subcort_to_DM,
                       hypo_subcort_to_FPVA = hypo_subcort_to_FPVA,
                       hyper_subcort_to_SMVI = hyper_subcort_to_SMVI,
                       hypo_cerebullum_to_striatum = hypo_cerebullum_to_striatum,
                       .id = "weigthFc") %>%
  rename(DX_weight = value)
  
```

```{r}
Fz_weigths %>%
  group_by(weigthFc) %>%
  summarize(n = n(),
           mean_DX = mean(DX_weight))
```
```{r}
FC_weighted <- Fz_weigths %>%
  inner_join(results_pheno, by = c("to", "from"))  %>%
  filter(vertex_type == "pvertex") %>%
  group_by(subject, Age, Sex, Site, DX, Age_pt, fd_mean_pt, weigthFc) %>%
  mutate(wcorZ = abs(DX_weight) * weight) %>%
  summarise(mwcorZ = sum(wcorZ)/sum(abs(DX_weight))) %>%
  ungroup()
```

```{r}
FC_weighted %>%
  ungroup() %>%
  group_by(weigthFc) %>%
  do(tidy(lm(mwcorZ ~ DX + Age_pt + Sex + fd_mean_pt + Site,.))) %>%
  select(weigthFc, term, statistic, p.value) %>%
  knitr::kable()
```
```{r}
SSD_cors <- FC_weighted %>%
  filter(DX == "SSD") %>%
  select(subject, weigthFc, mwcorZ) %>%
  spread(weigthFc, mwcorZ) %>%
  select(-subject) %>%
  cor(.) 
```

```{r}
HC_cors <- FC_weighted %>%
  filter(DX == "CTRL") %>%
  select(subject, weigthFc, mwcorZ) %>%
  spread(weigthFc, mwcorZ) %>%
  select(-subject) %>%
  cor(.) 

HC_cors %>%
  as.data.frame() %>%
  mutate(from = row.names(.)) %>%
  gather(to, hc_cor, -from) %>%
  ggplot(aes(x = to, y = from, fill = hc_cor)) +
  geom_tile() +
  geom_text(aes(label = sprintf('%3.2f',hc_cor))) +
  scale_fill_distiller(breaks = c(-0.5,0.5), type = "div", palette = 5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
  
```
```{r}
SSD_cors %>%
  as.data.frame() %>%
  mutate(from = row.names(.)) %>%
  gather(to, hc_cor, -from) %>%
  ggplot(aes(x = to, y = from, fill = hc_cor)) +
  geom_tile() +
  geom_text(aes(label = sprintf('%3.2f',hc_cor))) +
  scale_fill_distiller(breaks = c(-0.5,0.5), type = "div", palette = 5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```
```{r}
# Marginal densities along x axis
plot_DX_scatter_elipsed <- function(df, x, y) {
  #the tidy eval ness
  xvar <- enquo(x)
  yvar <- enquo(y)
  # make the main scatte bit using above
  main_scatter <-  ggplot(data = df, 
               aes(x = !!xvar, y = !!yvar, color = DX)) +
  geom_point(alpha = 0.7, size = 0.7) +
  stat_ellipse() +
  scale_color_manual(values = c("grey20","red"))

  xdens <- axis_canvas(main_scatter, axis = "x")+
    geom_density(data = df, aes(x = !!xvar, fill = DX),
              alpha = 0.5, size = 0.2) +
    scale_fill_manual(values = c("grey20","red"))

  ydens <- axis_canvas(main_scatter, axis = "y", coord_flip = TRUE)+
    geom_density(data = df, aes(x = !!yvar, fill = DX),
                alpha = 0.5, size = 0.2) +
  scale_fill_manual(values = c("grey20","red")) +
  coord_flip()
  
  #putting the peices together
  p1 <- insert_xaxis_grob(main_scatter, xdens, grid::unit(.2, "null"), position = "top")
  p2<- insert_yaxis_grob(p1, ydens, grid::unit(.2, "null"), position = "right")
  return(p2)
}
```


```{r , fig.height=4, fig.width = 5}
library(cowplot)
fplot <- FC_weighted %>%
  spread(weigthFc, mwcorZ) 

ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_DM, y = hypo_cerebullum_to_striatum))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_SMVI, y = hypo_cerebullum_to_striatum))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_SMVI, y = hypo_subcort_to_FPVA))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_cortVADA_to_SMVI, y = hypo_cortDM_to_DAVASM))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, 
                               x = hypo_cerebullum_to_striatum, 
                               y = hypo_cortDM_to_DAVASM))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, 
                               x = hyper_subcort_to_SMVI, 
                               y = hypo_cortDM_to_DAVASM))
```



## cray cray newer stuff starts here

```{r, fig.height=12}
sig_edges <- DX_lm_model %>%
  filter(term %in% c("DXSSD"), p_FDR < 0.05, vertex_type == "pvertex") %>%
  select(to, from) %>% 
  unite(edgename, to, from)

thing_cluster <- results_pheno %>%
  filter(vertex_type == "pvertex") %>%
  select(subject, to, from, weight) %>%
  unite(edgename, to, from) %>%
  filter(edgename %in% sig_edges$edgename) %>%
  spread(edgename, weight) 

thing_cluster_pca <- prcomp(thing_cluster %>% select( -subject), center = TRUE) 
```

```{r}
summary(thing_cluster_pca)
```


```{r fig.width=20, fig.height=36}
DX_lm_model %>%
  filter(term == "Age_pt") %>%
  ungroup() %>%
  mutate(sig = if_else(p_FDR < 0.05, '*', NA_character_),
         to_names = factor(to, levels = c(Yeo7_2011_80verts$SHORTNAME, 
                                          the_subcortical_guide$combined_name)),
         from_names = factor(from, levels = c(Yeo7_2011_80verts$SHORTNAME, 
                                              the_subcortical_guide$combined_name))) %>%
ggplot(aes(x = from_names, y = to_names, fill = statistic)) + 
  geom_tile(na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2(midpoint = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1)
```
```{r}

```

