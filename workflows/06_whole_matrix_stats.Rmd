---
title: "Whole Connectome Stats"
output:
  html_document:
    keep_md: true
---

We are now going to see if there is anything in cortical-cortical connectivity by running the matrix of all possible connections instead of just subcortical-cortical stats. 

```{r message=FALSE, warning=FALSE}
library(tidygraph)
library(tidyverse)
library(broom)
library(knitr)
library(cowplot)
library(igraph)
library(ggraph)
```

## The paths to data


```{r setting paths}
# These functions are for reading timeseries files
source('../R/settings_helpers.R')
source('../R/meants_reading_helpers.R')

pheno <- read_pheno_file()%>%
  drop_na(DX)
YeoNet_colours <- define_Yeo7_colours()
Yeo7_2011_80verts <- read_Yeo72011_template()  
```

# Code for reading in all the timeseries..


A table that describes the current expected subortical files



These functions are for reading timeseries files




This reads all files and generate PINT to subcortical correlation values for a given subject

```{r read and correlated function}

the_subcortical_guide <- get_subcortical_guide()

#run_read_subject_subcort_corrs(subcort_outputlist$subid[1])

```

## This was run once in order to detemine the too small subcortical ROIs

```{r eval = FALSE}
read_vx_count <- function(filepath) {
  read_csv(filepath, col_names = FALSE) %>%
    mutate(network = c('VI','SM','DA','VA', 'LI','FP','DM')) 
}

vx_counts <- the_subcortical_guide %>%
  select(subcort_hemi, subcort_ROI) %>%
  distinct() %>%
  mutate(vx_count = str_c('../data/ciftify_fmriprep/ZHH/out/ciftify_meants/templates/7RSN_roi-',subcort_hemi, subcort_ROI,'_vxcount.txt')) %>%
mutate(vxnum = map(vx_count, ~read_vx_count(.x))) %>%
  unnest() %>%
  select(subcort_hemi, subcort_ROI, X1, network) %>%
  rename(numvx = X1)

write_csv(vx_counts, '../templates/subcort_vxcounts.csv')
```



```{r}
node_annotations <- get_node_annotations(Yeo7_2011_80verts, the_subcortical_guide)
```



### This reads all the subcortical files it can find

Write a func_base and outputprefix cols into the pheno file for the file reading step

```{r}
pheno <- pheno %>%
  mutate(func_base = get_func_base_from_pint_summary_filename(filename,subject, session), 
         outputprefix = construct_output_prefix(subject, session, func_base)) 
```

```{r eval = FALSE}
safely(map2(pheno$outputprefix, pheno$dataset,
                              ~run_read_all_subject_timeseries_and_corZ(.x, .y)))
```


```{r read all the data}

all_corZ_results <- pheno %>%
  select(subject, outputprefix, dataset) %>%
  mutate(the_corrs = map2(.$outputprefix, .$dataset,
                              ~run_read_all_subject_timeseries_and_wholebrain_corZ(.x, .y)))
```

### merge with the phenotypic data

```{r merge with pheno and clean}
results_pheno <- all_corZ_results %>%
  inner_join(pheno, by = "subject") %>%
  unnest()  

```


```{r eval = FALSE}
results_pheno
```

```{r}
DX_lm_model_full <- results_pheno %>%
  semi_join(node_annotations, by = c("to"="node_name")) %>%
  semi_join(node_annotations, by = c("from"="node_name")) %>%
  mutate(corZ = weight) %>%
  group_by(vertex_type, to, from) %>%
  do(tidy(lm(corZ ~ DX + Age_pt + Sex + fd_mean_pt + Scanner,.))) 
```


```{r}
annotated_graph_edges <- DX_lm_model_full %>%
  ungroup() %>%
  select(to, from) %>%
  distinct() %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name"), suffix = c('_to','_from')) %>%
  unite(from_to_type, etype_from, etype_to) %>%
  unite(hemis, hemi_from, hemi_to, sep = "") %>%
  unite(networks, network_from, network_to, sep = "", remove = FALSE) %>%
  mutate(from_to_type = recode(from_to_type, "Cort_SubCort" = "SubCort_Cort")) %>%
  mutate(hemis = recode(hemis, "RL" = "LR")) 

```

## filters out some unwanted edges before FDR correction

```{r}
DX_lm_model <- DX_lm_model_full %>%
  ungroup() %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(withinsubcort = if_else((from_to_type == "SubCort_SubCort") & (subcort_ROI_from == subcort_ROI_to), "drop", "keep")) %>%
  filter(withinsubcort == "keep") %>%
  select(vertex_type, to, from, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)
```

## Make co

```{r fig.height=10, fig.width=10}
source('../R/swirly_plot_helpers.R')
DX_lm_model %>%
  ungroup() %>%
  ## filtering steps
  filter(term == "DXSSD") %>%
  filter(vertex_type == "pvertex") %>%
  
  ## make a pretty plot
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Personalized",
                      node_annotations = node_annotations)
```


```{r fig.height=10, fig.width=10}
DX_lm_model %>%
  ungroup() %>%
  filter(term == "DXSSD") %>%
  filter(vertex_type == "tvertex") %>%
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Template",
                      node_annotations = node_annotations)
```


```{r fig.height=10, fig.width=10}
DX_lm_model %>%
  ungroup() %>%
  filter(term == "DXSSD") %>%
  filter(vertex_type == "tvolume") %>%
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "Volume",
                      node_annotations = node_annotations)
```

## make table FDR corrected Edges that survive correction

```{r}
DX_lm_model %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(sig_edge = if_else(p_FDR < 0.05, "sig", "ns"),
         stat_pos = if_else(statistic > 0, "pos", "neg")) %>%
  filter(term == "DXSSD") %>% 
  count(vertex_type, from_to_type, sig_edge) %>%
  spread(sig_edge, n) %>%
  mutate(perc_sig = sig/(ns + sig)*100)

```



```{r}
#' convert from three col graph df to adjacency matrix
uppertri_df_to_agjmat <- function(graph_df) {
  
names(graph_df) <- c('to', 'from', 'myattr')
matrix_out <- graph_df %>%
  graph_from_data_frame(.,directed = F) %>%
  get.adjacency(., type = "both", attr = "myattr") %>%
  as.matrix() 
return(matrix_out)
}

#' go uppertri data to full dataframe for geom_tile
uppertri_df_to_full <- function(graph_df) {
result <- graph_df %>%
  uppertri_df_to_agjmat() %>%
  as.data.frame() %>%
  mutate(to = row.names(.)) %>%
  gather(from, value, -to) 
return(result)
}
```





```{r fig.height=20, fig.width= 12}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
  mutate(t_filtered = if_else(p_FDR < 0.1, statistic, 0)) %>%
  ungroup() %>%
  select(vertex_type, to, from, t_filtered) %>%
  group_by(vertex_type) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  mutate(to_lab = factor(to, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name),
         from_lab = factor(from, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name)) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1) +
  labs(title = "T statistic for effect of DX (thesholded)",
       x = NULL, y = NULL, fill = "T statistic for DX")
```

`













```{r fig.height=12, fig.width= 12}
full_DX_mat <- DX_lm_model %>%
  filter(term == "DXSSD", vertex_type == "pvertex") %>%
  ungroup() %>%
  select(to, from, statistic) %>%
  uppertri_df_to_full() 

full_DX_mat %>%
  mutate(to_lab = factor(to, levels = node_annotations$node_name), 
         from_lab = factor(from, levels = node_annotations$node_name)) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "T statistic for effect of DX",
       x = NULL, y = NULL, fill = "T statistic for DX")
```

```{r}

calc_fc_weights <- function(lm_df, t_threshold) {
  
    full_DX_mat <- lm_df %>%
      ungroup() %>%
      select(to, from, statistic) %>%
      uppertri_df_to_full() %>%
      inner_join(node_annotations, by = c("to"="node_name")) %>%
      inner_join(node_annotations, by = c("from"="node_name")) 
    
hypo_cerebullum_to_striatum <- full_DX_mat %>%
    filter(subcort_ROI.x == "cerebellum") %>%
    filter(subcort_ROI.y == "striatum") %>%
    filter(value < -t_threshold) %>%
    select(to, from, value)

hyper_subcort_to_SMVI <- full_DX_mat %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("VI", "SM")) %>%
    filter(value > t_threshold) %>%
    select(to, from, value)

hyper_subcort_to_DM <- full_DX_mat %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("DM")) %>%
    filter(value > t_threshold) %>%
    select(to, from, value)

hypo_subcort_to_FP <- full_DX_mat %>%
    filter(etype.x == "SubCort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.y) %in% c("FP")) %>%
    filter(value < -t_threshold) %>%
    select(to, from, value)

hyper_cortSMVI_to_rest <- full_DX_mat %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("SM", "VI")) %>%
    filter(as.character(network.y) %in% c("FP","DA", "VA", "DM")) %>%
    filter(value > t_threshold) %>%
    select(to, from, value)

hyper_cortVA_to_DA <- full_DX_mat %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("VA")) %>%
    filter(as.character(network.y) %in% c("DA")) %>%
    filter(value > t_threshold) %>%
    select(to, from, value)

hypo_cortDM_to_rest <- full_DX_mat %>%
    filter(etype.x == "Cort") %>%
    filter(etype.y == "Cort") %>%
    filter(as.character(network.x) %in% c("DM")) %>%
    filter(!(as.character(network.y) %in% c("DM"))) %>%
    filter(value > -t_threshold) %>%
    select(to, from, value)

Fz_weigths <-bind_rows(hypo_cortDM_to_rest = hypo_cortDM_to_rest,
                       hyper_cortSMVI_to_rest = hyper_cortSMVI_to_rest,
                       hyper_cortVA_to_DA = hyper_cortVA_to_DA,
                       hyper_subcort_to_DM = hyper_subcort_to_DM,
                       hypo_subcort_to_FP = hypo_subcort_to_FP,
                       hyper_subcort_to_SMVI = hyper_subcort_to_SMVI,
                       hypo_cerebullum_to_striatum = hypo_cerebullum_to_striatum,
                       .id = "FC_subtype") %>%
  rename(edge_FC_weight = value)

  return(Fz_weigths)

}
  
```

```{r}
Fz_DXweigths_pvertex <- DX_lm_model %>%
  filter(term == "DXSSD", vertex_type == "pvertex") %>%
  ungroup() %>%
  calc_fc_weights(.,2)
```

```{r}
Fz_DXweigths_tvertex <- DX_lm_model %>%
  filter(term == "DXSSD", vertex_type == "tvertex") %>%
  ungroup() %>%
  calc_fc_weights(.,2)
```

```{r}
Fz_DXweigths_tvolume <- DX_lm_model %>%
  filter(term == "DXSSD", vertex_type == "tvolume") %>%
  ungroup() %>%
  calc_fc_weights(.,2)
```

```{r}
write_csv(Fz_DXweigths_pvertex, "../data/intermediate/SSD_FC_weights/SSD4cohorts_DXtweigths_pvertex.csv")
write_csv(Fz_DXweigths_tvertex, "../data/intermediate/SSD_FC_weights/SSD4cohorts_DXtweigths_tvertex.csv")
write_csv(Fz_DXweigths_tvolume, "../data/intermediate/SSD_FC_weights/SSD4cohorts_DXtweigths_tvolume.csv")
```



```{r}

#' calculates a subjects weigthed FC score from their edgewise values
#'
#' @param subject_edges_df tibble with columns subject, to, from, and weight
#' @param FC_weights tibble with columns FC_subtype, to, from, and edge_FC_weight
#'
#' @return tibble with columns subject, FC_subtype and wFC_score
#'
#' @examples
calc_subjects_FC_score <- function(subject_edges_df, FC_weights) {
  result <- subject_edges_df %>%
  ungroup() %>%
  group_by(subject) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  inner_join(FC_weights, by = c("to", "from")) %>%
  ungroup() %>%
  mutate(wcorZ = abs(edge_FC_weight) * value) %>%
  group_by(subject, FC_subtype) %>%
  summarise(mwcorZ = sum(wcorZ)/sum(abs(edge_FC_weight))) %>%
  ungroup()
}
```

```{r}
pvertex_subject_FC_scores <- results_pheno %>%
  ungroup() %>%
  filter(vertex_type == "pvertex") %>%
  select(subject, to, from, weight) %>%
  calc_subjects_FC_score(Fz_DXweigths_pvertex)
```

```{r}
tvertex_subject_FC_scores <- results_pheno %>%
  ungroup() %>%
  filter(vertex_type == "tvertex") %>%
  select(subject, to, from, weight) %>%
  calc_subjects_FC_score(Fz_DXweigths_tvertex)
```

```{r}
tvolume_subject_FC_scores <- results_pheno %>%
  ungroup() %>%
  filter(vertex_type == "tvolume") %>%
  select(subject, to, from, weight) %>%
  calc_subjects_FC_score(Fz_DXweigths_tvolume)
```

```{r}
FC_scores_together <- bind_rows(
  pvertex = pvertex_subject_FC_scores,
  tvertex = tvertex_subject_FC_scores,
  tvolume = tvolume_subject_FC_scores,
  .id = "vertex_type"
)

write_csv(FC_scores_together, '../data/intermediate/SSD_DX_subject_scores/SSD4cohorts_DXweighted_subject_scores.csv')
```




```{r}
FC_scores_together %>%
  inner_join(pheno, by = "subject") %>%
  ungroup() %>%
  group_by(FC_subtype, vertex_type) %>%
  do(tidy(lm(mwcorZ ~ DX + Age_pt + Sex + fd_mean_pt + Site,.))) %>%
  select(FC_subtype, vertex_type, term, statistic, p.value) %>%
  filter(term == "DXSSD") %>%
  knitr::kable()
```
```{r}
SSD_cors <- FC_weighted %>%
  filter(DX == "SSD") %>%
  select(subject, weigthFc, mwcorZ) %>%
  spread(weigthFc, mwcorZ) %>%
  select(-subject) %>%
  cor(.) 
```

```{r}
HC_cors <- FC_weighted %>%
  filter(DX == "CTRL") %>%
  select(subject, weigthFc, mwcorZ) %>%
  spread(weigthFc, mwcorZ) %>%
  select(-subject) %>%
  cor(.) 

HC_cors %>%
  as.data.frame() %>%
  mutate(from = row.names(.)) %>%
  gather(to, hc_cor, -from) %>%
  ggplot(aes(x = to, y = from, fill = hc_cor)) +
  geom_tile() +
  geom_text(aes(label = sprintf('%3.2f',hc_cor))) +
  scale_fill_distiller(breaks = c(-0.5,0.5), type = "div", palette = 5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
  
```
```{r}
SSD_cors %>%
  as.data.frame() %>%
  mutate(from = row.names(.)) %>%
  gather(to, hc_cor, -from) %>%
  ggplot(aes(x = to, y = from, fill = hc_cor)) +
  geom_tile() +
  geom_text(aes(label = sprintf('%3.2f',hc_cor))) +
  scale_fill_distiller(breaks = c(-0.5,0.5), type = "div", palette = 5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```
```{r}
# Marginal densities along x axis
plot_DX_scatter_elipsed <- function(df, x, y) {
  #the tidy eval ness
  xvar <- enquo(x)
  yvar <- enquo(y)
  # make the main scatte bit using above
  main_scatter <-  ggplot(data = df, 
               aes(x = !!xvar, y = !!yvar, color = DX)) +
  geom_point(alpha = 0.7, size = 0.7) +
  stat_ellipse() +
  scale_color_manual(values = c("grey20","red"))

  xdens <- axis_canvas(main_scatter, axis = "x")+
    geom_density(data = df, aes(x = !!xvar, fill = DX),
              alpha = 0.5, size = 0.2) +
    scale_fill_manual(values = c("grey20","red"))

  ydens <- axis_canvas(main_scatter, axis = "y", coord_flip = TRUE)+
    geom_density(data = df, aes(x = !!yvar, fill = DX),
                alpha = 0.5, size = 0.2) +
  scale_fill_manual(values = c("grey20","red")) +
  coord_flip()
  
  #putting the peices together
  p1 <- insert_xaxis_grob(main_scatter, xdens, grid::unit(.2, "null"), position = "top")
  p2<- insert_yaxis_grob(p1, ydens, grid::unit(.2, "null"), position = "right")
  return(p2)
}
```


```{r , fig.height=4, fig.width = 5}
library(cowplot)
fplot <- FC_weighted %>%
  spread(weigthFc, mwcorZ) 

ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_DM, y = hypo_cerebullum_to_striatum))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_SMVI, y = hypo_cerebullum_to_striatum))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_subcort_to_SMVI, y = hypo_subcort_to_FPVA))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, x = hyper_cortVADA_to_SMVI, y = hypo_cortDM_to_DAVASM))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, 
                               x = hypo_cerebullum_to_striatum, 
                               y = hypo_cortDM_to_DAVASM))
```

```{r, fig.width=5, fig.height = 4}
ggdraw(plot_DX_scatter_elipsed(fplot, 
                               x = hyper_subcort_to_SMVI, 
                               y = hypo_cortDM_to_DAVASM))
```



## cray cray newer stuff starts here

```{r, fig.height=12}
sig_edges <- DX_lm_model %>%
  filter(term %in% c("DXSSD"), p_FDR < 0.05, vertex_type == "pvertex") %>%
  select(to, from) %>% 
  unite(edgename, to, from)

thing_cluster <- results_pheno %>%
  filter(vertex_type == "pvertex") %>%
  select(subject, to, from, weight) %>%
  unite(edgename, to, from) %>%
  filter(edgename %in% sig_edges$edgename) %>%
  spread(edgename, weight) 

thing_cluster_pca <- prcomp(thing_cluster %>% select( -subject), center = TRUE) 
```

```{r}
summary(thing_cluster_pca)
```


```{r fig.width=20, fig.height=36}
DX_lm_model %>%
  filter(term == "Age_pt") %>%
  ungroup() %>%
  mutate(sig = if_else(p_FDR < 0.05, '*', NA_character_),
         to_names = factor(to, levels = c(Yeo7_2011_80verts$SHORTNAME, 
                                          the_subcortical_guide$combined_name)),
         from_names = factor(from, levels = c(Yeo7_2011_80verts$SHORTNAME, 
                                              the_subcortical_guide$combined_name))) %>%
ggplot(aes(x = from_names, y = to_names, fill = statistic)) + 
  geom_tile(na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2(midpoint = 0) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1)
```
```{r}

```

```{r fig.height=20, fig.width= 12, eval = FALSE}
mean_cors <- results_pheno %>%
  mutate(corZ = weight) %>%
  group_by(vertex_type, to, from) %>%
  summarise(mcorZ = mean(corZ))

mean_cors %>%
  ungroup() %>%
  select(vertex_type, to, from, mcorZ) %>%
  group_by(vertex_type) %>%
  nest() %>%
  mutate(uptri = map(data, uppertri_df_to_full)) %>%
  unnest(uptri) %>%
  mutate(to_lab = factor(to, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name),
         from_lab = factor(from, levels = (node_annotations %>% arrange(subcort_ROI, network))$node_name)) %>%
  filter(to %in% Yeo7_2011_80verts$SHORTNAME) %>%
  filter(from %in% Yeo7_2011_80verts$SHORTNAME) %>%
  ggplot(aes(x=to_lab, y=from_lab, fill=value)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(high = "#b2182b", mid = "white", low = "#2166ac") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~vertex_type, ncol = 1) +
  labs(title = "edgewise mean cor (Z)",
       x = NULL, y = NULL, fill = "correlation (Z)")
```
