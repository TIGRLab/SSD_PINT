---
title: "Mass Univariate - with PINT outputs"
output:
  html_document:
    df_print: paged
---

Mass univartiate testing of PINT outputs from SPINS vs scog and perceptual scores 



```{r}
library(tidyverse)
library(igraph)
library(broom)
```

Read the pheno data for the models

```{r setting paths}
outputdir = '../data_spins/derivatives/'


## adding a subid that matches what the concatenation script adds..
pheno_all <- read_csv('../data_spins/pheno/SPINS_dems_plus_QA.csv') %>%
  mutate(site = str_sub(subject, 5,7)) %>%
  mutate_at(vars(age, education, ends_with('meanFD')), ~ as.numeric(scale(.x))) %>%
  filter(subject != "sub-ZHP0161",
         subject != "sub-MRC0020",
         subject != "sub-ZHP0108")

## read in Lindsay's factors
NCSC_conn_factor_scores_2019_09_17 <- read_csv("../data_spins/pheno/NCSC_conn_factor_scores_2019-09-17.csv")
#conn_factor_scores_2018_08_07 <- read_csv("../data_spins/pheno/conn_factor_scores_2018-08-07.csv")
soc_cog_factor_scores_2019_10_15 <- read_csv("../data_spins/pheno/soc_cog_factor_scores_2019-10-15.csv")


## join Lindsay's factors with the demographics
SPINS_pheno_factors <- pheno_all %>%
  left_join(soc_cog_factor_scores_2019_10_15, by = "record_id") %>%
  left_join(NCSC_conn_factor_scores_2019_09_17, by = "record_id") 
```





```{r}

recordid_to_bidssubject <- function(this_record_id) {
str_c('sub-',
      str_sub(this_record_id, 7, 9),
      str_sub(this_record_id, 11, 14))
}

#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_pint_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double())) %>% 
     t() %>% 
     as.data.frame()
  names(meants) = Yeo7_2011_80verts$SHORTNAME
  return(meants)
}

```

```{r}
# These functions are for reading timeseries files
source('../R/settings_helpers.R')
YeoNet_colours <- define_Yeo7_colours()
Yeo7_2011_80verts <- read_Yeo72011_template()  
the_subcortical_guide <- get_subcortical_guide()
```


```{r}


#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double()))
   return(meants)
}


#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_pint_meants_csv <- function(filepath) {
   meants <-read_meants_csv(filepath) %>%
     t() %>%
     as.tibble()
   
   names(meants) <- Yeo7_2011_80verts$SHORTNAME
   return(meants)
}
# task = 'task-emp_run-3'
# subject = pheno_all$subject[1]
# session = pheno_all$session[1]


```



```{r}

#' read all fMRI timeseries data from yeo7 rsn subcortical
#' sub-CMH0001_ses-01_task-emp_run-3_desc-cleans0_atlas-7rsnRstriatum_meants.csv
#'
#' @param outputdir the path to the pint output directory
#' @param subject the path to sub-study project (dataset)
#' @param session as data frame describing the PINT ROIs 
#' @param task as data frame describing the PINT ROIs
#'
#' @return a tibble of all the subcorical data from one scan

read_subject_task_subcorts <- function(subject, session, task) {

subcort_meants <- the_subcortical_guide %>%
  # get the atlas names from the subcortical guide
  mutate(atlas = str_c('7rsn', subcort_hemi, subcort_ROI)) %>%
  distinct(atlas) %>%
  pull(atlas) %>%
  # build the filenames
  map(~ file.path(outputdir, 'ciftify_meants', subject, session, 'func',
                str_c(subject, "_", session, "_", task,
                                 '_desc-cleans0_atlas-', .x, '_meants.csv'))) %>%
  # read in the csvs
  map(~ read_meants_csv(.x)) %>%
  # row bind them together, tranpose and convert to tibble
  bind_rows() %>%
  t() %>% 
  as.tibble()

# rename the rows with the subcortical ROI names
names(subcort_meants) <- the_subcortical_guide$combined_name

return (subcort_meants)
}


## test run 
# read_subject_task_subcorts(pheno_all$subject[1], pheno_all$session[1], 'task-emp_run-3')
```
```{r}
#' works in the situation here where the PINT runs are concatenated but the subcort meants is not
#'
#' @param subcort_meants1
#' @param subcort_meants2 
#' @param pint_meants 
#'
#' @return a dataframe with to and from edgenames as well as Z transformed correlation
calc_PINT_plus_subcort_cor_df <- function(subcort_meants, pint_meants) {
  result <- bind_cols(pint_meants, subcort_meants) %>%
    cor() %>%
    atanh() %>%
    graph_from_adjacency_matrix(mode="upper", 
                                   weighted=T, diag=F) %>%
    as_data_frame()
  return(result)
}

#' binds subcortical to cortical timeseries and calculates graph
#'
#' @param all_meants 
#'
#' @return a dataframe with to and from edgenames as well as Z transformed correlation
calc_PINT_cor_df <- function(all_meants) {
  result <- all_meants %>%
    cor() %>%
    atanh() %>%
    graph_from_adjacency_matrix(mode="upper", 
                                   weighted=T, diag=F) %>%
    as_data_frame()
  return(result)
}

```



```{r}
#' Reads meants outputs, contanenates the relavent subcortical ones, and correlates
#'
#' @param meants_search_pattern a search pattern to find the meants files (for reading the PINT data)
#' @param task1 the task label for the first task (for reading subcortical data)
#' @param task2 the task label of the second task (for reading subcortical data)
#' @param pheno_df the subject list for filtering out QC fails (need to have bids subject column)
#'
#' @return tibble with two columes subject and data is nested correlations (from, to, weigth)
read_and_correlated_one_resulttype <- function(meants_search_pattern, task1, task2, pheno_df) {
 results <- tibble(myfilepath = Sys.glob(meants_search_pattern)) %>%
 mutate(filename = basename(as.character(myfilepath)),
        subject = str_sub(filename, 1, 11),
        session = 'ses-01')  %>%
 semi_join(pheno_df, by = "subject")  %>%
 select(subject, session, myfilepath)  %>%
 group_by(subject) %>%
 mutate(thePINTdata = map(myfilepath, ~read_pint_meants_csv(.x))) %>%
 mutate(subcort1data = map2(subject, session, ~ read_subject_task_subcorts(.x,.y, task1))) %>%
 mutate(subcort2data = map2(subject, session, ~ read_subject_task_subcorts(.x,.y, task2))) %>%
 mutate(subcortdata = map2(subcort1data, subcort2data, ~bind_rows(.x,.y)))  %>%
 transmute(theZs = map2(subcortdata, thePINTdata, ~calc_PINT_plus_subcort_cor_df(.x,.y)))
 return(results)
}
```

## This is were the data reading acutally starts (p.s. these cells take a while to run)

-tvertex vs qvertex
   -tvertex: template ROIs
   -qvertex: pint was run on another run from the same person

```{r}
corZ_tvertex_crestemp2 <- read_and_correlated_one_resulttype(
  meants_search_pattern = "../data_spins/derivatives/ciftify_PINT/sub-*/ses-01/func/sub-*_ses-01_task-crestemp2_desc-cleans8_tvertex_meants.csv",
  task1 = "task-rest",
  task2 = "task-emp_run-2",
  pheno_df = SPINS_pheno_factors
) 
```

```{r}
corZ_qvertex_crestemp2 <- read_and_correlated_one_resulttype(
  meants_search_pattern = "../data_spins/derivatives/ciftify_PINT/sub-*/ses-*/func/sub-*_ses-*_task-crestemp2_desc-cleans8_atlas-PINTcemp1emp3_qvertex_meants.csv",
  task1 = "task-rest",
  task2 = "task-emp_run-2",
  pheno_df = SPINS_pheno_factors
) 
```

```{r}
corZ_tvertex_cemp1emp3 <- read_and_correlated_one_resulttype(
  meants_search_pattern = "../data_spins/derivatives/ciftify_PINT/sub-*/ses-01/func/sub-*_ses-01_task-cemp1emp3_desc-cleans8_tvertex_meants.csv",
  task1 = "task-emp_run-1",
  task2 = "task-emp_run-3",
  pheno_df = filter(SPINS_pheno_factors, subject != "sub-MRP0151")
) 
```

```{r}
corZ_qvertex_cemp1emp3 <- read_and_correlated_one_resulttype(
  meants_search_pattern = "../data_spins/derivatives/ciftify_PINT/sub-*/ses-*/func/sub-*_ses-*_task-cemp1emp3_desc-cleans8_atlas-PINTcrestemp2_qvertex_meants.csv",
  task1 = "task-emp_run-1",
  task2 = "task-emp_run-3",
  pheno_df = filter(SPINS_pheno_factors, subject != "sub-MRP0151")
) 
```

## this actually does the mass univariate testing..

```{r}
crestemp2_DX_lm_fits <- bind_rows(
    tvertex = corZ_tvertex_crestemp2,
    qvertex = corZ_qvertex_crestemp2,
    .id = "vertex_type") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  unnest() %>%
  ungroup() %>%
  group_by(to, from, vertex_type) %>%
  do(tidy(lm(weight ~ group + age + sex + site + `task-crestemp2_meanFD`, data = .))) 
```

```{r}
cemp1emp3_DX_lm_fits <- bind_rows(
    tvertex = corZ_tvertex_cemp1emp3,
    qvertex = corZ_qvertex_cemp1emp3,
    .id = "vertex_type") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  unnest() %>%
  ungroup() %>%
  group_by(to, from, vertex_type) %>%
  do(tidy(lm(weight ~ group + age + sex + site + `task-cemp1emp3_meanFD`, data = .))) 
```

```{r}
node_annotations <- get_node_annotations(Yeo7_2011_80verts, the_subcortical_guide)
annotated_graph_edges <- crestemp2_DX_lm_fits %>%
  ungroup() %>%
  select(to, from) %>%
  distinct() %>%
  inner_join(node_annotations, by = c("to"="node_name")) %>%
  inner_join(node_annotations, by = c("from"="node_name"), suffix = c('_to','_from')) %>%
  unite(from_to_type, etype_from, etype_to) %>%
  unite(hemis, hemi_from, hemi_to, sep = "") %>%
  unite(networks, network_from, network_to, sep = "", remove = FALSE) %>%
  mutate(from_to_type = recode(from_to_type, "Cort_SubCort" = "SubCort_Cort")) %>%
  mutate(hemis = recode(hemis, "RL" = "LR")) 

```

## filters out some unwanted edges before FDR correction

```{r}
DX_lm_models_fdr <- bind_rows(cemp1emp3 = cemp1emp3_DX_lm_fits,
                              crestemp2 = crestemp2_DX_lm_fits,
                              .id = "task") %>%
  ungroup() %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(withinsubcort = if_else((from_to_type == "SubCort_SubCort") & (subcort_ROI_from == subcort_ROI_to), "drop", "keep")) %>%
  filter(withinsubcort == "keep") %>%
  select(vertex_type, task, to, from, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)
```

## Make co

```{r fig.height=10, fig.width=10}
library(tidygraph)
library(ggraph)
source('../R/swirly_plot_helpers.R')
DX_lm_models_fdr %>%
  ungroup() %>%
  ## filtering steps
  filter(vertex_type == "tvertex",
         task == "crestemp2",
         term == "groupSSD") %>%
  ## make a pretty plot
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "SPINS rest emp2 template",
                      node_annotations = node_annotations)
```

```{r fig.height=10, fig.width=10}
DX_lm_models_fdr %>%
  ungroup() %>%
  ## filtering steps
  filter(vertex_type == "qvertex",
         task == "crestemp2",
         term == "groupSSD") %>%
  ## make a pretty plot
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "SPINS rest emp2 cross PINT",
                      node_annotations = node_annotations)
```

```{r fig.height=10, fig.width=10}
DX_lm_models_fdr %>%
  ungroup() %>%
  ## filtering steps
  filter(vertex_type == "qvertex",
         task == "cemp1emp3",
         term == "groupSSD") %>%
  ## make a pretty plot
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "SPINS emp1 emp3 cross PINT",
                      node_annotations = node_annotations)
```

```{r fig.height=10, fig.width=10}
DX_lm_models_fdr %>%
  ungroup() %>%
  ## filtering steps
  filter(vertex_type == "tvertex",
         task == "cemp1emp3",
         term == "groupSSD") %>%
  ## make a pretty plot
  make_swirly_results_plot(pos_label = "SSD > HC", 
                      neg_label = "HC > SSD",
                      plot_title = "SPINS emp1 emp3 tvertex",
                      node_annotations = node_annotations)
```



```{r}
#' convert from three col graph df to adjacency matrix
uppertri_df_to_agjmat <- function(graph_df) {
  
names(graph_df) <- c('to', 'from', 'myattr')
matrix_out <- graph_df %>%
  graph_from_data_frame(.,directed = F) %>%
  get.adjacency(., type = "both", attr = "myattr") %>%
  as.matrix() 
return(matrix_out)
}

#' go uppertri data to full dataframe for geom_tile
uppertri_df_to_full <- function(graph_df) {
result <- graph_df %>%
  uppertri_df_to_agjmat() %>%
  as.data.frame() %>%
  mutate(to = row.names(.)) %>%
  gather(from, value, -to) 
return(result)
}
```

```{r}

#' calculates a subjects weigthed FC score from their edgewise values
#'
#' @param subject_edges_df tibble with columns subject, to, from, and weight
#' @param FC_weights tibble with columns FC_subtype, to, from, and edge_FC_weight
#'
#' @return tibble with columns subject, FC_subtype and wFC_score
#'
#' @examples
calc_subject_FC_score <- function(subject_edges_df, FC_weights) {
  result <- subject_edges_df %>%
  uppertri_df_to_full() %>%
  inner_join(FC_weights, by = c("to", "from")) %>%
  ungroup() %>%
  mutate(wcorZ = abs(edge_FC_weight) * value) %>%
  group_by(FC_subtype) %>%
  summarise(mwcorZ = sum(wcorZ)/sum(abs(edge_FC_weight))) %>%
  ungroup()
}

```

```{r}
Fz_DXweigths_pvertex <- read_csv('../data/intermediate/SSD_FC_weights/SSD4cohorts_DXtweigths_pvertex.csv')
Fz_DXweigths_tvertex <- read_csv('../data/intermediate/SSD_FC_weights/SSD4cohorts_DXtweigths_tvertex.csv')
```


```{r}
SSDPINTtvertex_wFC_scores <- bind_rows(
    tvertex_cemp1emp3 = corZ_tvertex_cemp1emp3,
    qvertex_cemp1emp3 = corZ_qvertex_cemp1emp3,
    tvertex_crestemp2 = corZ_tvertex_crestemp2,
    qvertex_crestemp2 = corZ_qvertex_crestemp2,
    .id = "vertex_task") %>%
    group_by(vertex_task, subject) %>%
    transmute(SSDPINT_scores = map(theZs, 
                                 ~calc_subject_FC_score(.x,Fz_DXweigths_tvertex))) %>%
    unnest()

SSDPINTpvertex_wFC_scores <- bind_rows(
    tvertex_cemp1emp3 = corZ_tvertex_cemp1emp3,
    qvertex_cemp1emp3 = corZ_qvertex_cemp1emp3,
    tvertex_crestemp2 = corZ_tvertex_crestemp2,
    qvertex_crestemp2 = corZ_qvertex_crestemp2,
    .id = "vertex_task") %>%
    group_by(vertex_task, subject) %>%
    transmute(SSDPINT_scores = map(theZs, 
                                 ~calc_subject_FC_score(.x,Fz_DXweigths_pvertex))) %>%
    unnest()
```
--- RAN to here ---

```{r}
recalc_DX_effects <- bind_rows(SSDPINTtvertex = SSDPINTtvertex_wFC_scores,
          SSDPINTpvertex = SSDPINTpvertex_wFC_scores,
          .id = "wFC_src") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  group_by(FC_subtype, wFC_src, task, vertex_type) %>%
do(tidy(lm(mwcorZ ~ group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) 

recalc_DX_effects %>%
  filter(term == "groupSSD") %>%
  select(FC_subtype, vertex_type, statistic, p.value) %>%
  knitr::kable()
```
```{r}
recalc_DX_effects %>%
  filter(term == "groupSSD") %>%
  ggplot(aes(x = vertex_type, y = abs(statistic))) +
  geom_boxplot() +
  geom_point(aes(color = FC_subtype)) + 
  facet_wrap(~ task*wFC_src, ncol = 4)
```

```{r}
recalc_DX_effects <- SSDPINTtvertex_wFC_scores %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  filter(task == "cemp1emp3", vertex_type == "tvertex") %>%
  group_by(FC_subtype, task, vertex_type) %>%
do(tidy(lm(mwcorZ ~ mentalizing.x + group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  group_by(term) %>%
  mutate(p_bonf = p.adjust(p.value, method = "bonferroni"))

recalc_DX_effects %>%
  filter(term == "mentalizing.x") %>%
  select(FC_subtype, vertex_type, statistic, p.value, p_bonf) %>%
  knitr::kable()
```
```{r}
unique(recalc_DX_effects$term)
```

```{r}
recalc_DX_effects <- SSDPINTtvertex_wFC_scores %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  filter(vertex_type == "tvertex") %>%
  group_by(FC_subtype, task, vertex_type) %>%
do(tidy(lm(mwcorZ ~ mentalizing.y*group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  group_by(term) %>%
  mutate(p_bonf = p.adjust(p.value, method = "bonferroni"))

recalc_DX_effects %>%
  filter(term %in% c("mentalizing.y", "groupSSD", "mentalizing.y:groupSSD")) %>%
  select(FC_subtype, task, vertex_type, statistic, p.value, p_bonf) %>%
  knitr::kable()
```

```{r fig.width = 10}
recalc_DX_effects %>%
  filter(term %in% c("mentalizing.y", "groupSSD", "mentalizing.y:groupSSD")) %>%
  ggplot(aes(x = task, y = abs(statistic))) +
  geom_boxplot() +
  geom_point(aes(color = FC_subtype)) + 
  facet_wrap(~ term,, nrow = 1)

```




```{r}
recalc_DX_effects <- SSDPINTtvertex_wFC_scores %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  filter(task == "cemp1emp3", vertex_type == "tvertex") %>%
  group_by(FC_subtype, task, vertex_type) %>%
do(tidy(lm(mwcorZ ~ Learning + group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  group_by(term) %>%
  mutate(p_bonf = p.adjust(p.value, method = "bonferroni"))

recalc_DX_effects %>%
  filter(term == "Learning") %>%
  select(FC_subtype, vertex_type, statistic, p.value, p_bonf) %>%
  knitr::kable()
```

```{r}
cemp1emp3_ment_lm_fits <- corZ_tvertex_cemp1emp3 %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  unnest() %>%
  ungroup() %>%
  group_by(to, from) %>%
  do(tidy(lm(weight ~ mentalizing.y + group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  ungroup() %>%
  inner_join(annotated_graph_edges, by = c("to", "from")) %>%
  mutate(withinsubcort = if_else((from_to_type == "SubCort_SubCort") & (subcort_ROI_from == subcort_ROI_to), "drop", "keep")) %>%
  filter(withinsubcort == "keep") %>%
  select(to, from, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr"))
```

```{r}
cemp1emp3_ment_lm_fits %>%
  filter(p.value < 0.005, term == "mentalizing.y") %>%
  arrange(to, from) %>%
  knitr::kable()
```



```{r}
recalc_DX_effects <- SSDPINTtvertex_wFC_scores %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  filter(vertex_type == "tvertex") %>%
  group_by(FC_subtype, task, vertex_type) %>%
do(tidy(lm(mwcorZ ~ simulation.x + group + age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  group_by(term) %>%
  mutate(p_bonf = p.adjust(p.value, method = "bonferroni"))

recalc_DX_effects %>%
  filter(term == "simulation.x") %>%
  select(FC_subtype, task, statistic, p.value, p_bonf) %>%
  knitr::kable()
```




```{r}
FCscores_regressed <- SSDPINTtvertex_wFC_scores %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  ungroup() %>%
  filter(vertex_type == "tvertex") %>%
  ungroup() %>%
  group_by(FC_subtype, task, vertex_type) %>%
  do(augment(lm(mwcorZ ~ age + sex + site + `task-crestemp2_meanFD` + `task-cemp1emp3_meanFD`, data = .))) %>%
  inner_join(SPINS_pheno_factors, by = c("age","sex","site"))
```

```{r fig.height=12, fig.width=5}
FCscores_regressed %>%
  ungroup() %>%
  filter(FC_subtype == "hyper_subcort_to_SMVI", 
         vertex_type == "tvertex") %>%
  ggplot(aes(y = `.resid`, x = mentalizing.x, color = group)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_grid(site~task*group, scales = "free")
```


```{r}
SSDPINTtvertex_wFC_scores %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  ungroup() %>%
  filter(FC_subtype == "hyper_subcort_to_SMVI", 
         task == "cemp1emp3",
         vertex_type == "tvertex") %>%
  ggplot(aes(y = mwcorZ, x = mentalizing.x, color = group)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~site)
```
```{r}
SSDPINTtvertex_wFC_scores %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  ungroup() %>%
  filter(FC_subtype == "hyper_subcort_to_SMVI", 
         vertex_type == "tvertex") %>%
  ggplot(aes(y = mwcorZ, x = mentalizing.x, color = group)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(~task)+
  labs(y = "Weighted FC btw subcortical and SM + VI cortical", x = "mentalizing")
```
```{r}
SSDPINTtvertex_wFC_scores %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  ungroup() %>%
  filter(FC_subtype == "hypo_cerebullum_to_striatum", 
         vertex_type == "tvertex") %>%
  ggplot(aes(y = mwcorZ, x = mentalizing.x, color = group)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(~task)+
  labs(y = "Weighted FC btw cerebellum and striatum", x = "mentalizing")
```
```{r}
SSDPINTtvertex_wFC_scores %>%
  separate(vertex_task, into  = c("vertex_type", "task"), sep = "_") %>%
  inner_join(SPINS_pheno_factors, by = "subject") %>%
  ungroup() %>%
  filter(FC_subtype == "hyper_cortVA_to_DA", 
         vertex_type == "tvertex") %>%
  ggplot(aes(y = mwcorZ, x = mentalizing.x, color = group)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  facet_wrap(~task) +
  labs(y = "Weighted FC btw VA and DA cortical", x = "mentalizing")
```

