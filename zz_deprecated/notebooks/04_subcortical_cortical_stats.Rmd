---
title: "Sub-cortical Cortical Stats"
output:
  html_document:
    keep_md: TRUE
---

# Sub-cortical Cortical Stats

This analysis tries to combine timeseries data from PINT outputs with subcortical timeseries to ask two questions

1. "External" validation of PINT. If PINT is indeed helping us better target meaningful resting state networks than we should see "cleaner" patterns of between the PINT output cortical ROIs and parcels of the subcortical structure that have been associated with these networks in literature.
   + i.e. connectivity of the cortical ROIS with "expected" subcortical parcel should increae and correlation with other parcels should decrease after PINT.
   
2. To interograte SSD related differences in Cortical-Subcortical connectivity - and to see if they persist after PINT.


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(knitr)
library(tableone)
library(cowplot)
```


## The paths to data

```{r setting paths}
pint_outputs <- '../data/PINT_outputs_s8_6-6-12/'
subcortical_outputs_dir <- '/KIMEL/tigrlab/projects/dmiranda/subcortical/output_ts/'

Yeo7_2011_80verts <- read_csv("../templates/Yeo7_2011_80verts.csv",
                              col_types = c(
                                hemi = col_character(),
                                tvertex = col_integer(),
                                LRpairs = col_integer(),
                                roiidx = col_integer(),
                                NETWORK = col_integer(),
                                LOBE = col_character(),
                                SHORTNAME = col_character(),
                                x = col_integer(),
                                y = col_integer(),
                                z = col_integer()
                              ))
```

# read and mangle the phenotypic data

```{r reading-phenotypic-data}

## reading in the qced_sublists csv to get the sublists
pheno <- read_csv("../phenotypic/subjects_not_sexmatched_20180507.csv", 
                  col_types = c(
  subid = col_character(),
  name = col_character(),
  Site = col_character(),
  DX = col_character(),
  age = col_integer(),
  Sex = col_character(),
  Edu = col_double(),
  mean_fd = col_double(),
  X.bad_fd = col_double(),
  global_corr = col_double(),
  mean_snfr = col_double()
))
  
```

## adding transformed variables 

```{r mangle-pheno}
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- car::powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

pheno <- pheno %>%
  mutate(Age_pt = transform_to_normal(age),
         mean_fd_pt = transform_to_normal(mean_fd),
         Edu_std = scale(Edu)[,1],
         Age_std = scale(age)[,1])
```


# Code for reading in all the timeseries..

## searching for the meants files

```{r finding-pint-outputs}
pint_outputlist <- tibble("filepath" = list.files(pint_outputs, 
                                                      recursive = T,
                                                      pattern = "_summary.csv")) %>%
  separate(filepath, into = c("subid", "summary_file"), sep = '/')

subcort_outputlist <- tibble("subid" = list.files(subcortical_outputs_dir, 
                                                      recursive = F))

pint_outputlist <- inner_join(pint_outputlist, subcort_outputlist, by = "subid")

```

A table that describes the current expected subortical files

```{r define-subcotical-files}
# a tibble table to specify the subcortical meants files that were generated
YeoNet_subcort_list <- c('VI','SM','DA','VA', 'LI','FP','DM')
```

These functions are for reading timeseries files

```{r subcortical file reading functions}

#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double()))
   return(meants)
}

#' Read the contents of a subcortical csv
#'
#' @param subid The subject identifier
#' @param subregion region "thalamus", "stiatum", "cerebellum"
#' @param pint_outputs the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_subcortical_meants <- function(subid, subregion, subcortical_outputs_dir) {
  expected_filepath <- file.path(subcortical_outputs_dir, subid, 
                           str_c(subid, '_s0_rsn_', subregion, '_7networks_networks_MWfix.dlabel_meants.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}

#' Read the contents of a csv generated by PINT
#'
#' @param subid The subject identifier
#' @param vertex_type "ivertex" or "tvertex"
#' @param pint_outputs the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_pint_meants <- function(subid, vertex_type, pint_outputs) {
  expected_filepath <- file.path(pint_outputs, subid, 
                           str_c(subid, '_', vertex_type, '_meants.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}
```


This reads all files and generate PINT to subcortical correlation values for a given subject

```{r read and correlated function}


#' read all fMRI timeseries data for one subject and correlates PINT ROIs with subcortex
#'
#' @param subid the subject id
#' @param pint_outputs the path to the pint output directory
#' @param subcortical_outputs_dir the path to the subcortical timeseries directory
#' @param Yeo7_2011_80verts as data frame describing the PINT ROIs 
#'
#' @return a dataframe (graph style) of PINT ROI to subcortical correlations
subject_subcort_corrs <- function(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts) {
  
  # read the pint meants files
  ivertex_meants <- read_pint_meants(subid, 'ivertex', pint_outputs)
  tvertex_meants <- read_pint_meants(subid, 'tvertex', pint_outputs)
  
  # read the subcortical meants files
  thalamus_meants <- read_subcortical_meants(subid, "thalamus", subcortical_outputs_dir)
  striatum_meants <- read_subcortical_meants(subid, "striatum", subcortical_outputs_dir)
  cerebellum_meants <- read_subcortical_meants(subid, "cerebellum", subcortical_outputs_dir)
  
  # prepare to bind
  subcort_meants <- bind_rows(thalamus_meants, striatum_meants, cerebellum_meants)
  subcort_region_list <- c(rep("thalamus", nrow(thalamus_meants)), 
                           rep("striatum", nrow(striatum_meants)),
                           rep("cerebellum", nrow(cerebellum_meants)))
  subcort_net_list <- rep(c('VI','SM','DA','VA', 'LI','FP','DM'),3)
  
  # correlate the ivertex timeseries with the subcortical data
  ivertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(ivertex_meants)))
  names(ivertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  ivertex_result <- ivertex_subcortcorr %>%
    mutate(subcort_ROI = subcort_region_list,
           subcort_NET = subcort_net_list) %>%
    gather(PINT_ROI, ivertex_corr, -subcort_ROI, -subcort_NET)
  
  # correlated the tvertex timeseries with the subcortical data
  tvertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(tvertex_meants)))
  names(tvertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  tvertex_result <- tvertex_subcortcorr %>%
    mutate(subcort_ROI = subcort_region_list,
           subcort_NET = subcort_net_list) %>%
    gather(PINT_ROI, tvertex_corr, -subcort_ROI, -subcort_NET)
  
  # combine ivertex and tvertex and return
  subresult <- ivertex_result %>%
    inner_join(tvertex_result, by = c("PINT_ROI", "subcort_ROI", "subcort_NET"))
  return(subresult)
}

```


### This reads all the subcortical files it can find

```{r read all the data}

run_read_subject_subcort_corrs <- function(subid) {
  df <-subject_subcort_corrs(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts)
  return(df)
}


all_subcort_results <- pint_outputlist %>%
  mutate(subcort_corrs = map(subid, ~run_read_subject_subcort_corrs(.x)))
```


### merge with the phenotypic data

```{r merge with pheno and clean}
results_pheno <- all_subcort_results %>%
  inner_join(pheno, by = "subid") %>%
  unnest() %>%
  mutate(YeoNet = str_sub(PINT_ROI, 1,2),
         hemisphere = str_sub(PINT_ROI, 5,5)) %>%
  mutate(conn_type = if_else(YeoNet == subcort_NET, "same_net", "diff_net"),
         YeoNet = factor(YeoNet, levels = c("VI", "SM", "DA", "VA", "FP", "DM")),
         subcort_NET = factor(subcort_NET, levels = c("VI", "SM", "DA", "VA", "FP", "DM", "LI"))) %>%
  #       ) %>%
  select(subid, PINT_ROI, subcort_ROI, subcort_NET,
         ivertex_corr, tvertex_corr, 
         DX, Edu, Sex, mean_fd, age, Site,
         Age_pt, mean_fd_pt, Edu_std, Age_std, 
         YeoNet, hemisphere, conn_type) 

```




## make a subject table from resuts pheno


```{r report demographics}
library(tableone)
therealtable1 <- CreateTableOne(
  strata = c("Site", "DX"),
  vars = c("age", "Edu", "Sex"),
  data = filter(results_pheno, PINT_ROI=="DMP1L",subcort_ROI=="thalamus", subcort_NET=="VA")
)

print(therealtable1)

```

# Is PINT "focusing" cortical subcortical connectivity

```{r plotting-PINT-change-matrix, fig.height=8}
table1 <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  gather(corr_type, rval, ivertex_corr, tvertex_corr) %>%
  group_by(corr_type, YeoNet, subcort_ROI, subcort_NET) %>%
  summarise(n = n(),
            Mean = mean(rval),
            SD = sd(rval)) 
  
ggplot(table1, aes(y = YeoNet, x = subcort_NET, fill = Mean)) + 
  geom_tile() +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(subcort_ROI~corr_type) 

```

We see in the above figure that the Yeo 7 Network connectivity strongly shows the expected pattern in the cerebeullum. 

Lower evidence is seen in the striatum and thalamus, although there is a faint increase across the diagonal for the SM, VA and DM especially

```{r paired-ttests-of-PINT-effect}
net_means <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, conn_type, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup()

net_means_pint_t <- net_means %>%
  group_by(YeoNet, subcort_ROI, subcort_NET) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means_pint_t %>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_) ) %>%
ggplot(aes(x = YeoNet, y = subcort_NET, fill = statistic)) + 
  geom_tile(color = "black", na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~subcort_ROI)
```
Here we plot the paired t-stat camparing personalized to template, we see a very strong increase in correlation along the diagonal (i.e. with the hypothesized regions) and decreases on the off-dignonal (i.e. decreased connectivity with the other network's parcels)


# trying to calculate an vs off diagonal term

```{r net-focus-tstats}
net_focus <- net_means %>%
  ungroup() %>%
  mutate(pint_diff = netmean_ivertex - netmean_tvertex) %>%
  group_by(subid, subcort_ROI, YeoNet, conn_type) %>%
  summarise(nets_avg = mean(pint_diff)) %>%
  ungroup() %>%
  spread(conn_type, nets_avg) %>%
  mutate(focus_effect = same_net - diff_net)

net_focus %>%
  ungroup() %>%
  group_by(subcort_ROI, YeoNet) %>%
  do(tidy(t.test(.$focus_effect)))
```

In the above table to calcuculated the "focussing" effect as the change (in on person) between in connectivity with the expected parcel subtracted by the change in connectivity from other regions.

Below we plot these values against zero

```{r net-focus-figure}
net_focus %>%
  ungroup() %>%
  ggplot(aes(x = YeoNet, y = focus_effect)) +
  geom_violin() +
  geom_jitter(alpha = 0.1) +
  geom_hline(yintercept = 0) +
  facet_wrap(~ subcort_ROI)
  
```

Recreating the DM plot from the poster to double check

```{r DM-subcortical-plot-part1}

net_means <- results_pheno %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr),
            pint_diff = netmean_ivertex - netmean_tvertex) 

pint_diff_sub_DM <- net_means %>%
  ungroup() %>% 
  filter(YeoNet == "DM", subcort_ROI == "striatum") %>%
  select(subid, subcort_NET, pint_diff) %>%
  spread(subcort_NET, pint_diff) %>%
  mutate(overall_pint_diff = DM - (SM + VA + FP)/3,
         x_val = '') %>%
  select(subid, overall_pint_diff, x_val) %>%
  ggplot(aes(y = overall_pint_diff, x = x_val)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(alpha = 0.3, color = '#cd3e4e', fill = "grey") +
    geom_hline(yintercept = 0) + 
    labs(y = "Change in correlation after PINT", x = "Striatum DM - Others") +
  scale_y_continuous(limits = c(-0.3, 0.3))

DM_submeans_plot <- net_means %>%
  mutate(is_DM = if_else(subcort_NET == 'DM', TRUE, FALSE)) %>%
  filter(YeoNet == "DM", 
         subcort_ROI == "striatum",
         subcort_NET %in% c('SM', "VA", "DM", 'FP')) %>%
  ggplot(aes(y = pint_diff, x = subcort_NET, color = is_DM)) +
  geom_boxplot(color = "black") + 
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c('black','#cd3e4e')) +
  labs(y = "Change in correlation after PINT", color = NULL, x = "Subregion of Striatum") +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(-0.3, 0.3))

# DM_brain_pic <- ggdraw + draw_image('DM_striatum_pic.png')

plot_grid(pint_diff_sub_DM, DM_submeans_plot, rel_widths = c(1,2.5))
```

Also the VA Striatum one

```{r VA-subcortical-plot}

pint_diff_sub_VA <- net_means %>%
  ungroup %>% 
  filter(YeoNet == "VA", subcort_ROI == "striatum") %>%
  select(subid, subcort_NET, pint_diff) %>%
  spread(subcort_NET, pint_diff) %>%
  mutate(overall_pint_diff = VA - (SM + DM + FP)/3,
         x_val = '') %>%
  select(subid, overall_pint_diff, x_val) %>%
  ggplot(aes(y = overall_pint_diff, x = x_val)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.3, color = '#c43afa', fill = "grey") +
    geom_hline(yintercept = 0) + 
    labs(y = "Change in correlation after PINT", x = "Striatum VA - Others") +
  scale_y_continuous(limits = c(-0.3, 0.3))

VA_submeans_plot <- net_means %>%
  mutate(is_VA = if_else(subcort_NET == 'VA', TRUE, FALSE),
          SubCort_ROI = factor(subcort_NET, 
                               levels = c("VA", 'SM', 'FP', "DM"))) %>%
  filter(YeoNet == "VA", 
         subcort_ROI == "striatum",
         subcort_NET %in% c('SM', "VA", "DM", 'FP')) %>%
  ggplot(aes(y = pint_diff, x = SubCort_ROI, color = is_VA)) +
  geom_boxplot(color = "black") + 
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c('black','#c43afa')) +
  labs(y = "Change in correlation after PINT", color = NULL, x = "Subregion of Striatum") +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(-0.3, 0.3))

# DM_brain_pic <- ggdraw + draw_image('DM_striatum_pic.png')

plot_grid(pint_diff_sub_VA, VA_submeans_plot, rel_widths = c(1,2.5))
```
## Plotting the PINT effect separately in SSD and controls

Note that the circle denotes an uncorrected p<0.05

```{r plotting-PINT-effect-separately-by-DX}
net_means_byDX <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, subid, DX) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, DX) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means_byDX %>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_) ) %>%
ggplot(aes(x = YeoNet, y = subcort_NET, fill = statistic)) + 
  geom_tile(color = "black", na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(subcort_ROI ~ DX)
```


```{r plotting-striatal-cortical-by-DX-and-PINT}
results_pheno %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, subid, DX, age) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(age > 17, age < 51) %>%
  ggplot(aes(x = YeoNet, y=subcort_NET, fill = netmean_corZ)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  facet_grid(subcort_ROI ~ DX*vertex_type)
```

## running model again with sex interaction

```{r running-subcortical-model-with-sex-interaction}
library(knitr)

DX_lm_model <- results_pheno %>%
  gather(vertex_type, corZ, ivertex_corr, tvertex_corr) %>%
  filter(age > 17, age < 51) %>%
  group_by(vertex_type, subcort_ROI, subcort_NET, PINT_ROI) %>%
  do(tidy(lm(corZ ~ DX + Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, subcort_NET, PINT_ROI, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

DX_lm_model %>% 
  filter(term %in% c("DXSSD", "SexM")) %>%
  filter(p.value < 0.1) 


```

```{r}
DX_lm_model <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, hemisphere, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  group_by(vertex_type, subcort_ROI, subcort_NET, YeoNet) %>%
  do(tidy(lm(netmean_corZ ~ DX + Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, YeoNet, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

kable(DX_lm_model %>% filter(term %in% c("DXSSD"), p.value < 0.06))
```
```{r}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
  select(subcort_ROI, subcort_NET, vertex_type, YeoNet, statistic) %>%
  spread(vertex_type, statistic) %>%
  ggplot(aes(x = netmean_ivertex, y = netmean_tvertex)) +
  geom_point(aes(color=YeoNet)) +
  geom_abline(slope = 1, intercept =0) +
  facet_wrap(~subcort_NET)
```

```{r}
DX_lm_model %>%
  mutate(matchnet = if_else(as.character(subcort_NET)==as.character(YeoNet), TRUE, FALSE)) %>%
  filter(term == "DXSSD",
         matchnet==TRUE) %>%
  select(subcort_ROI, subcort_NET, vertex_type, YeoNet, statistic, term) %>%
  spread(vertex_type, statistic) %>%
  ggplot(aes(x = netmean_ivertex, y = netmean_tvertex)) +
  geom_point(aes(color=subcort_NET)) +
  geom_abline(slope = 1, intercept = 0)
```

![](VA_Striatum_pic.png)
##################################### Edit from Here! ################################################################

```{r plotting-model-DX-ttstats}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
ggplot(aes(x = YeoNet, y=subcort_NET, fill = statistic)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-4.5,-4.5)) +
  facet_grid(subcort_ROI~ vertex_type)
```



```{r VA-DX-effect-figure, fig.height=8, fig.width = 8}
fig1 <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(Personalized = mean(ivertex_corr),
            Template = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, Personalized, Template) %>%
  filter(YeoNet == "VA", subcort_NET == "VA") %>%
  ggplot(aes(y = netmean_corZ, x = DX, color = DX)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_dotplot(aes(fill = Sex), 
               binaxis = 'y', stackdir = 'center', binwidth = 0.025, alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(subcort_ROI ~ Site*vertex_type) +
  labs(y = "Striatum- Cortex Resting State Correlation (Z)")

#ggsave(fig1, filename = 'VA_results.png',height = 8, width = 5)

fig1
```
```{r DM-DX-effect-figure, fig.height=8, fig.width = 8}
fig2 <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, subcort_NET,
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(Personalized = mean(ivertex_corr),
            Template = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, Personalized, Template) %>%
  filter(YeoNet == "DM", subcort_NET == "DM") %>%
  ggplot(aes(y = netmean_corZ, x = DX, color = DX)) + 
  geom_boxplot(outlier.shape = NA) +  
  geom_dotplot(aes(fill = Sex), 
               binaxis = 'y', stackdir = 'center', binwidth = 0.025, alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(subcort_ROI ~ Site*vertex_type) +
  labs(y = "Striatum- Cortex Resting State Correlation (Z)")

#ggsave(fig2, filename = 'DM_results.png',height = 8, width = 5)

fig2
```




