---
title: "Striatum Cortical Stats"
output:
  html_document:
    keep_md: TRUE
---

Going to Start Loading saba's PINT data


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(knitr)
```


## The paths to data

```{r setting paths}
pint_outputs <- '../data/PINT_outputs_s8_6-6-12/'
subcortical_outputs_dir <- '/projects/dmiranda/subcortical/output_ts/'

Yeo7_2011_80verts <- read_csv("../templates/Yeo7_2011_80verts.csv",
                              col_types = c(
                                hemi = col_character(),
                                tvertex = col_integer(),
                                LRpairs = col_integer(),
                                roiidx = col_integer(),
                                NETWORK = col_integer(),
                                LOBE = col_character(),
                                SHORTNAME = col_character(),
                                x = col_integer(),
                                y = col_integer(),
                                z = col_integer()
                              ))
```

# read and mangle the phenotypic data

```{r reading-phenotypic-data}

## reading in the qced_sublists csv to get the sublists
pheno <- read_csv("../phenotypic/subjects_not_sexmatched_20180507.csv", 
                  col_types = c(
  subid = col_character(),
  name = col_character(),
  Site = col_character(),
  DX = col_character(),
  age = col_integer(),
  Sex = col_character(),
  Edu = col_double(),
  mean_fd = col_double(),
  X.bad_fd = col_double(),
  global_corr = col_double(),
  mean_snfr = col_double()
))
  
```

## adding transformed variables 

```{r mangle-pheno}
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- car::powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

pheno <- pheno %>%
  mutate(Age_pt = transform_to_normal(age),
         mean_fd_pt = transform_to_normal(mean_fd),
         Edu_std = scale(Edu)[,1],
         Age_std = scale(age)[,1])
```


# Code for reading in all the timeseries..

## searching for the meants files

```{r finding-pint-outputs}
pint_outputlist <- data.frame("filepath" = list.files(pint_outputs, 
                                                      recursive = T,
                                                      pattern = "_summary.csv")) %>%
  separate(filepath, into = c("subid", "summary_file"), sep = '/')

subcort_outputlist <- data.frame("subid" = list.files(subcortical_outputs_dir, 
                                                      recursive = F))

pint_outputlist <- inner_join(pint_outputlist, subcort_outputlist, by = "subid")
```

A table that describes the current expected subortical files

```{r define-subcotical-files}
# a tibble table to specify the subcortical meants files that were generated
YeoNet_subcort_list <- c('VI','SM','DA','VA', 'LI','FP','DM')
```

This function reads and concatenates all subcortical timeseries files for one subject

```{r subcortical file reading functions}

#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double()))
   return(meants)
}

#' Read the contents of a subcortical csv
#'
#' @param subid The subject identifier
#' @param subregion region "thalamus", "stiatum", "cerebellum"
#' @param pint_outputs the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_subcortical_meants <- function(subid, subregion, subcortical_outputs_dir) {
  expected_filepath <- file.path(subcortical_outputs_dir, subid, 
                           str_c(subid, '_s0_rsn_', subregion, '_7networks_networks_MWfix.dlabel_meants.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}

#' Read the contents of a csv generated by PINT
#'
#' @param subid The subject identifier
#' @param vertex_type "ivertex" or "tvertex"
#' @param pint_outputs the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_pint_meants <- function(subid, vertex_type, pint_outputs) {
  expected_filepath <- file.path(pint_outputs, subid, 
                           str_c(subid, '_', vertex_type, '_meants.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}
```


This reads all files and generate PINT to subcortical correlation values for a given subject

```{r read and correlated function}


#' read all fMRI timeseries data for one subject and correlates PINT ROIs with subcortex
#'
#' @param subid the subject id
#' @param pint_outputs the path to the pint output directory
#' @param subcortical_outputs_dir the path to the subcortical timeseries directory
#' @param Yeo7_2011_80verts as data frame describing the PINT ROIs 
#'
#' @return a dataframe (graph style) of PINT ROI to subcortical correlations
subject_subcort_corrs <- function(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts) {
  
  # read the pint meants files
  ivertex_meants <- read_pint_meants(subid, 'ivertex', pint_outputs)
  tvertex_meants <- read_pint_meants(subid, 'tvertex', pint_outputs)
  
  # read the subcortical meants files
  thalamus_meants <- read_subcortical_meants(subid, "thalamus", subcortical_outputs_dir)
  striatum_meants <- read_subcortical_meants(subid, "striatum", subcortical_outputs_dir)
  cerebellum_meants <- read_subcortical_meants(subid, "cerebellum", subcortical_outputs_dir)
  
  # prepare to bind
  subcort_meants <- bind_rows(thalamus_meants, striatum_meants, cerebellum_meants)
  subcort_region_list <- c(rep("thalamus", nrow(thalamus_meants)), 
                           rep("striatum", nrow(striatum_meants)),
                           rep("cerebellum", nrow(cerebellum_meants)))
  subcort_net_list <- rep(c('VI','SM','DA','VA', 'LI','FP','DM'),3)
  
  # correlate the ivertex timeseries with the subcortical data
  ivertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(ivertex_meants)))
  names(ivertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  ivertex_result <- ivertex_subcortcorr %>%
    mutate(subcort_ROI = subcort_region_list,
           subcort_NET = subcort_net_list) %>%
    gather(PINT_ROI, ivertex_corr, -subcort_ROI, -subcort_NET)
  
  # correlated the tvertex timeseries with the subcortical data
  tvertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(tvertex_meants)))
  names(tvertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  tvertex_result <- tvertex_subcortcorr %>%
    mutate(subcort_ROI = subcort_region_list,
           subcort_NET = subcort_net_list) %>%
    gather(PINT_ROI, tvertex_corr, -subcort_ROI, -subcort_NET)
  
  # combine ivertex and tvertex and return
  subresult <- ivertex_result %>%
    inner_join(tvertex_result, by = c("PINT_ROI", "subcort_ROI", "subcort_NET"))
  return(subresult)
}

```


### This reads all the subcortical files it can find

```{r read all the data}

run_read_subject_subcort_corrs <- function(subid) {
  df <-subject_subcort_corrs(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts)
  return(df)
}


all_subcort_results <- pint_outputlist %>%
  mutate(subcort_corrs = map(subid, ~run_read_subject_subcort_corrs(.x)))
```


### merge with the phenotypic data

```{r merge with pheno and clean}
results_pheno <- all_subcort_results %>%
  inner_join(pheno, by = "subid") %>%
  unnest() %>%
  mutate(YeoNet = str_sub(PINT_ROI, 1,2),
         hemisphere = str_sub(PINT_ROI, 5,5)) %>%
  mutate(YeoNet = factor(YeoNet, levels = c("VI", "SM", "DA", "VA", "FP", "DM")),
         subcort_NET = factor(subcort_NET, levels = c("VI", "SM", "DA", "VA", "FP", "DM")),
         conn_type = if_else(YeoNet == subcort_NET, "same_net", "diff_net")) %>%
  select(subid, PINT_ROI, subcort_ROI, subcort_NET,
         ivertex_corr, tvertex_corr, 
         DX, Edu, Sex, mean_fd, age, Site,
         Age_pt, mean_fd_pt, Edu_std, Age_std, 
         YeoNet, hemisphere, conn_type) 
  
results_pheno
```




## make a subject table from resuts pheno


```{r report demographics}
library(tableone)
therealtable1 <- CreateTableOne(
  strata = c("Site", "DX"),
  vars = c("age", "Edu", "Sex"),
  data = filter(results_pheno, PINT_ROI=="DMP1L",subcort_ROI=="Striatum_VA")
)

print(therealtable1)

```

# Is PINT "focusing" cortical subcortical connectivity

```{r plotting-PINT-change-matrix, fig.height=8}
table1 <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  gather(corr_type, rval, ivertex_corr, tvertex_corr, corr_diff) %>%
  group_by(corr_type, YeoNet, subcort_ROI, subcort_NET) %>%
  summarise(n = n(),
            Mean = mean(rval),
            SD = sd(rval)) 
  
ggplot(table1, aes(y = YeoNet, x = subcort_NET, fill = Mean)) + 
  geom_tile() +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_grid(subcort_ROI~corr_type) 

```

```{r paired-ttests-of-PINT-effect}
net_means <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  group_by(YeoNet, subcort_ROI, subcort_NET, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI, subcort_NET) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means%>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_) ) %>%
ggplot(aes(x = YeoNet, y = subcort_NET, fill = statistic)) + 
  geom_tile(color = "black", na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~subcort_ROI)
```
##################################### Edit from Here! ################################################################

```{r DM-subcortical-plot-part1}

net_means <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr),
            pint_diff = netmean_ivertex - netmean_tvertex) 

pint_diff_sub_DM <- net_means %>%
  ungroup %>% 
  filter(YeoNet == "DM", ) %>%
  select(subid, subcort_ROI, pint_diff) %>%
  spread(subcort_ROI, pint_diff) %>%
  mutate(overall_pint_diff = Striatum_DM - (Striatum_SM + Striatum_VA + Striatum_FP)/3,
         x_val = '') %>%
  select(subid, overall_pint_diff, x_val) %>%
  ggplot(aes(y = overall_pint_diff, x = x_val)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.3, color = '#cd3e4e', fill = "grey") +
    geom_hline(yintercept = 0) + 
    labs(y = "Change in correlation after PINT", x = "Striatum DM - Others") +
  scale_y_continuous(limits = c(-0.3, 0.3))
```

```{r DM-subcortical-plot-part-2}
library(forcats)
library(cowplot)

DM_submeans_plot <- net_means %>%
  mutate(is_DM = if_else(subcort_ROI == 'Striatum_DM', TRUE, FALSE),
          SubCort_ROI = factor(subcort_ROI, 
                               levels = c("Striatum_DM", 'Striatum_FP',"Striatum_VA",'Striatum_SM'),
                               labels = c('DM', 'FP','VA','SM'))) %>%
  filter(YeoNet == "DM", 
         subcort_ROI %in% c('Striatum_SM', "Striatum_VA", "Striatum_DM", 'Striatum_FP')) %>%
  ggplot(aes(y = pint_diff, x = SubCort_ROI, color = is_DM)) +
  geom_boxplot(color = "black") + 
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c('black','#cd3e4e')) +
  labs(y = "Change in correlation after PINT", color = NULL, x = "Subregion of Striatum") +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(-0.3, 0.3))

# DM_brain_pic <- ggdraw + draw_image('DM_striatum_pic.png')

plot_grid(pint_diff_sub_DM, DM_submeans_plot, rel_widths = c(1,2.5))
```


```{r VA-subcortical-plot}
net_means <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr),
            pint_diff = netmean_ivertex - netmean_tvertex) 

pint_diff_sub_VA <- net_means %>%
  ungroup %>% 
  filter(YeoNet == "VA") %>%
  select(subid, subcort_ROI, pint_diff) %>%
  spread(subcort_ROI, pint_diff) %>%
  mutate(overall_pint_diff = Striatum_VA - (Striatum_SM + Striatum_DM + Striatum_FP)/3,
         x_val = '') %>%
  select(subid, overall_pint_diff, x_val) %>%
  ggplot(aes(y = overall_pint_diff, x = x_val)) +
    geom_boxplot() +
    geom_jitter(alpha = 0.3, color = '#c43afa', fill = "grey") +
    geom_hline(yintercept = 0) + 
    labs(y = "Change in correlation after PINT", x = "Striatum VA - Others") +
  scale_y_continuous(limits = c(-0.3, 0.3))

VA_submeans_plot <- net_means %>%
  mutate(is_VA = if_else(subcort_ROI == 'Striatum_VA', TRUE, FALSE),
          SubCort_ROI = factor(subcort_ROI, 
                               levels = c("Striatum_VA", 'Striatum_SM', 'Striatum_FP',"Striatum_DM"),
                               labels = c('VA', 'SM', 'FP','DM'))) %>%
  filter(YeoNet == "VA", 
         subcort_ROI %in% c('Striatum_SM', "Striatum_VA", "Striatum_DM", 'Striatum_FP')) %>%
  ggplot(aes(y = pint_diff, x = SubCort_ROI, color = is_VA)) +
  geom_boxplot(color = "black") + 
  geom_jitter(alpha = 0.3) +
  geom_hline(yintercept = 0) +
  scale_color_manual(values = c('black','#c43afa')) +
  labs(y = "Change in correlation after PINT", color = NULL, x = "Subregion of Striatum") +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(-0.3, 0.3))

# DM_brain_pic <- ggdraw + draw_image('DM_striatum_pic.png')

plot_grid(pint_diff_sub_VA, VA_submeans_plot, rel_widths = c(1,2.5))
```


```{r plotting-PINT-effect-separately-by-DX}
net_means_byDX <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  group_by(YeoNet, subcort_ROI, subid, DX) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI, DX) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means_byDX %>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_) ) %>%
ggplot(aes(x = YeoNet, y = subcort_ROI, fill = statistic)) + 
  geom_tile(color = "black", na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ DX)
```


```{r plotting-striatal-cortical-by-DX-and-PINT}
results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid, DX, age) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(age > 17, age < 51) %>%
  ggplot(aes(x = YeoNet, y=subcort_ROI, fill = netmean_corZ)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  facet_wrap(vertex_type ~ DX)
```

## running model again with sex interaction

```{r running-subcortical-model-with-sex-interaction}
library(knitr)

DX_lm_model <- results_pheno %>%
  gather(vertex_type, corZ, ivertex_corr, tvertex_corr) %>%
  filter(age > 17, age < 51) %>%
  group_by(vertex_type, subcort_ROI, PINT_ROI) %>%
  do(tidy(lm(corZ ~ DX*Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, PINT_ROI, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

DX_lm_model %>% 
  filter(term %in% c("DXCtrl", "Sex2", "DXCtrl:Sex2")) %>%
  filter(p.value < 0.1) %>%
  kable()
```

```{r}
DX_lm_model <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, hemisphere, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  group_by(vertex_type, subcort_ROI, YeoNet) %>%
  do(tidy(lm(netmean_corZ ~ DX*Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, YeoNet, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

kable(DX_lm_model %>% filter(term %in% c("DXCtrl", "Sex2", "DXCtrl:Sex2"), p.value < 0.06))
```
```{r}
0.05/24
```

![](VA_Striatum_pic.png)
```{r}
unique(DX_lm_model$term)
```

```{r plotting-model-DX-ttstats}
DX_lm_model %>%
  filter(term == "DXSSD") %>%
ggplot(aes(x = YeoNet, y=subcort_ROI, fill = statistic)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-4.5,-4.5)) +
  facet_wrap(~ vertex_type, ncol = 4)
```
```{r plotting-model-Sex-Effects}
DX_lm_model %>%
  filter(term == "SexM") %>%
ggplot(aes(x = YeoNet, y=subcort_ROI, fill = statistic)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-4.5,-4.5)) +
  facet_wrap(~ vertex_type, ncol = 4)
```


```{r VA-DX-effect-figure, fig.height=8, fig.width = 5}
fig1 <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(Personalized = mean(ivertex_corr),
            Template = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, Personalized, Template) %>%
  filter(YeoNet == "VA", subcort_ROI == "Striatum_VA") %>%
  ggplot(aes(y = netmean_corZ, x = DX, color = DX)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_dotplot(aes(fill = Sex), 
               binaxis = 'y', stackdir = 'center', binwidth = 0.025, alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(Site ~ vertex_type) +
  labs(y = "Striatum- Cortex Resting State Correlation (Z)")

ggsave(fig1, filename = 'VA_results.png',height = 8, width = 5)

fig1
```
```{r DM-DX-effect-figure, fig.height=8, fig.width = 5}
fig2 <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(Personalized = mean(ivertex_corr),
            Template = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, Personalized, Template) %>%
  filter(YeoNet == "DM", subcort_ROI == "Striatum_DM") %>%
  ggplot(aes(y = netmean_corZ, x = DX, color = DX)) + 
  geom_boxplot(outlier.shape = NA) +  
  geom_dotplot(aes(fill = Sex), 
               binaxis = 'y', stackdir = 'center', binwidth = 0.025, alpha = 0.5) +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(Site ~ vertex_type) +
  labs(y = "Striatum- Cortex Resting State Correlation (Z)")

ggsave(fig2, filename = 'DM_results.png',height = 8, width = 5)

fig2
```




