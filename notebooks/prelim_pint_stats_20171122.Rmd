---
title: "Prelim PINT stats"
output:
  pdf_document: default
  html_notebook: default
---

Going to Start Loading saba's PINT data


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(broom)
library(igraph)
library(stringr)
library(tibble)
library(purrr)
library(ggplot2)
library(knitr)
```


## The paths to data

```{r}
pint_outputs <- '../data/PINT_outputs_s8_6-6-12/'
subcortical_outputs_dir <- '../data/subcortical_ts/'

Yeo7_2011_80verts <- read_csv("~/code/ciftify/ciftify/data/PINT/Yeo7_2011_80verts.csv",
                              col_types = c(
                                hemi = col_character(),
                                tvertex = col_integer(),
                                LRpairs = col_integer(),
                                roiidx = col_integer(),
                                NETWORK = col_integer(),
                                LOBE = col_character(),
                                SHORTNAME = col_character(),
                                x = col_integer(),
                                y = col_integer(),
                                z = col_integer()
                              ))
```

# read and mangle the phenotypic data

```{r}

## reading in the qced_sublists csv to get the sublists
qced_sublists <- read_csv("../phenotypic/NEWallSubjects_completeData3_DM_not_sexmatched.csv",
                          col_types = c(
                            X1 = col_integer(),
                            name = col_character(),
                            subid = col_character(),
                            DX_GROUP = col_integer(),
                            mean_fd = col_double(),
                            age = col_integer(),
                            sex.x = col_integer(),
                            educationCode = col_double(),
                            site = col_integer(),
                            sex.y = col_integer(),
                            X.bad_fd = col_double(),
                            global_corr = col_double(),
                            mean_snfr = col_double()
                          )) 
  
pheno <- qced_sublists %>%
  mutate(Site = factor(site, levels = c(1,2,3),
                       labels = c("CMH","ZHH","COBRE")) ,
         DX = factor(DX_GROUP, level = c(1,2), labels = c('SSD', 'Ctrl')),
         Sex = factor(sex.x),
         Edu = if_else(is.na(educationCode), 
                       true = mean(educationCode, na.rm = T), 
                       false = educationCode))
  
```

## adding transformed variables 

```{r}
transform_to_normal <- function(X) {
  # calculate the best exponent using powerTransform:
  pT <- car::powerTransform(X)
  # apply the power transform and save the result to a new variable
  X_pT <- X^pT$lambda ## note ^ is exponent in r
  return(X_pT)
}

pheno <- pheno %>%
  mutate(Age_pt = transform_to_normal(age),
         mean_fd_pt = transform_to_normal(mean_fd),
         Edu_std = scale(Edu)[,1],
         Age_std = scale(age)[,1])
```


# Code for reading in all the timeseries..

## searching for the meants files

```{r}
pint_outputlist <- data.frame("filepath" = list.files(pint_outputs, 
                                                      recursive = T,
                                                      pattern = "_summary.csv")) %>%
  separate(filepath, into = c("subid", "summary_file"), sep = '/')

subcort_outputlist <- data.frame("subid" = list.files(subcortical_outputs_dir, 
                                                      recursive = F))

pint_outputlist <- inner_join(pint_outputlist, subcort_outputlist, by = "subid")
```

A table that describes the current expected subortical files

```{r}
# a tibble table to specify the subcortical meants files that were generated
subcortical_files <- tribble(
  ~file_prefix, ~name,
  "Thalamus_corrected", "Thalamus", 
  "Striatum_network_1", "Striatum_VI",
"Striatum_network_2", "Striatum_SM",
"Striatum_network_3", "Striatum_DA",
"Striatum_network_4", "Striatum_VA",
"Striatum_network_5", "Striatum_Limbic",
"Striatum_network_6", "Striatum_FP",
"Striatum_network_7", "Striatum_DM")

kable(subcortical_files)
```

This function reads and concatenates all subcortical timeseries files for one subject

```{r}

#' read a meants file generated by PINT of ciftify_meants
#'
#' @param filepath the full path to the file
#'
#' @return a dataframe where rows are rois and colums are timepoints
read_meants_csv <- function(filepath) {
   meants <-read_csv(filepath, 
                     col_names = FALSE,
                     col_types = c(.default = col_double()))
   return(meants)
}

#' reads in the subcortical data for one subject specified in the subcortical template
#'
#' @param subid the subject id prefix for the output
#' @param subcortical_outputs_dir the base output directory for the subcortical ts data
#' @param subcortical_template a dataframe with a 'file_prefix' column decscribing the subcortical regions
#' @param smoothing the amount of smoothing on the origianl dtseries (defaults to 0)
#'
#' @return the cpmcatenated mean timeseries data as a dataframe
read_subcortical_meants <- function(subid, subcortical_outputs_dir, 
                                    subcortical_template = subcortical_files,
                                    smoothing = 's0') {
  subcort_meants <- subcortical_template %>%
    mutate(filepath = str_c(subcortical_outputs_dir,subid, '/', 
                            subid, '_', smoothing, '_', file_prefix, '.nii_meants.csv'),
           thedata = map(filepath, ~read_meants_csv(.x))) %>%
    select(thedata) %>%
    unnest() 
  return(subcort_meants)
}

#' Read the contents of a csv generated by PINT
#'
#' @param subid The subject identifier
#' @param vertex_type "ivertex" or "tvertex"
#' @param pint_outputs the basepath of the pint outputs
#'
#' @return a dataframe of the _meants.csv contents
read_pint_meants <- function(subid, vertex_type, pint_outputs) {
  expected_filepath <- file.path(pint_outputs, subid, 
                           str_c(subid, '_', vertex_type, '_meants.csv'))
  meants = read_meants_csv(expected_filepath)
  return(meants)
}
```

This reads all files and generate PINT to subcortical correlation values for a given subject

```{r}


#' read all fMRI timeseries data for one subject and correlates PINT ROIs with subcortex
#'
#' @param subid the subject id
#' @param pint_outputs the path to the pint output directory
#' @param subcortical_outputs_dir the path to the subcortical timeseries directory
#' @param Yeo7_2011_80verts as data frame describing the PINT ROIs 
#' @param subcortical_files a tibble of expected subcortical ts files
#'
#' @return a dataframe (graph style) of PINT ROI to subcortical correlations
subject_subcort_corrs <- function(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts, subcortical_files) {
  
  ivertex_meants <- read_pint_meants(subid, 'ivertex', pint_outputs)
  tvertex_meants <- read_pint_meants(subid, 'tvertex', pint_outputs)
  subcort_meants <- read_subcortical_meants(subid, 
                                            subcortical_outputs_dir, 
                                            subcortical_template = subcortical_files) 
  
  # correlate the ivertex timeseries with the subcortical data
  ivertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(ivertex_meants)))
  names(ivertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  ivertex_result <- ivertex_subcortcorr %>%
    mutate(subcort_ROI = subcortical_files$name) %>%
    gather(PINT_ROI, ivertex_corr, -subcort_ROI)
  
  # correlated the tvertex timeseries with the subcortical data
  tvertex_subcortcorr <- as.data.frame(cor(t(subcort_meants), t(tvertex_meants)))
  names(tvertex_subcortcorr) <- Yeo7_2011_80verts$SHORTNAME
  tvertex_result <- tvertex_subcortcorr %>%
    mutate(subcort_ROI = subcortical_files$name) %>%
    gather(PINT_ROI, tvertex_corr, -subcort_ROI)
  
  # combine ivertex and tvertex and return
  subresult <- ivertex_result %>%
    inner_join(tvertex_result, by = c("PINT_ROI", "subcort_ROI"))
  return(subresult)
}

```

### This reads all the subcortical files it can find

```{r}

run_read_subject_subcort_corrs <- function(subid) {
  df <-subject_subcort_corrs(subid, pint_outputs, subcortical_outputs_dir,
                                  Yeo7_2011_80verts, subcortical_files)
  return(df)
}

all_subcort_results <- pint_outputlist %>%
  mutate(subcort_corrs = map(subid, ~run_read_subject_subcort_corrs(.x)))
```

### merge with the phenotypic data

```{r}
results_pheno <- all_subcort_results %>%
  inner_join(pheno, by = "subid") %>%
  unnest() %>%
  mutate(YeoNet = str_sub(PINT_ROI, 1,2),
         hemisphere = str_sub(PINT_ROI, 5,5)) %>%
  mutate(YeoNet = factor(YeoNet, levels = c("VI", "SM", "DA", "VA", "FP", "DM")),
         subcort_ROI = factor(subcort_ROI,
                              levels = c("Thalamus", "Striatum_VI", "Striatum_SM",
                                         "Striatum_DA","Striatum_VA","Striatum_FP",
                                         "Striatum_DM","Striatum_Limbic"))) %>%
  select(subid, PINT_ROI, subcort_ROI, 
         ivertex_corr, tvertex_corr, 
         DX, Edu, Sex, mean_fd, age, Site,
         Age_pt, mean_fd_pt, Edu_std, Age_std, 
         YeoNet, hemisphere)

# classify the connections 
results_pheno <- results_pheno %>%
  separate(subcort_ROI, into = c("tmp", "Striatum_ROI"), 
           sep = '_', fill = "left", remove = FALSE) %>%
  ungroup() %>%
  mutate(conn_type = case_when(
    .$Striatum_ROI == "Thalamus" ~ "Thalamus",
    .$Striatum_ROI == .$YeoNet ~ "Striatum_same_net",
    TRUE ~ "Striatum_diff_net"))

```

# Is PINT "focusing" cortical subcortical connectivity

```{r fig.height = 8}
table1 <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  gather(corr_type, rval, ivertex_corr, tvertex_corr, corr_diff) %>%
  group_by(corr_type, PINT_ROI, subcort_ROI) %>%
  summarise(n = n(),
            Mean = mean(rval),
            SD = sd(rval)) 
  
ggplot(table1, aes(y = PINT_ROI, x = subcort_ROI, fill = Mean)) + 
  geom_tile() +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~corr_type, ncol = 3) 

```
```{r}
table2 <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  gather(corr_type, rval, ivertex_corr, tvertex_corr, corr_diff) %>%
  group_by(corr_type, YeoNet, subcort_ROI) %>%
  summarise(n = n(),
            Mean = mean(rval),
            SD = sd(rval)) 
  
ggplot(table2, aes(y = YeoNet, x = subcort_ROI, fill = Mean)) + 
  geom_tile() +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~corr_type, ncol = 3) 
```

```{r}
net_means <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means %>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_)) %>%
ggplot(aes(y = YeoNet, x = subcort_ROI, fill = statistic)) + 
  geom_tile(color = "white") +
  geom_point(aes(shape = sig)) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```


```{r}
net_means_byDX <- results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr) %>%
  group_by(YeoNet, subcort_ROI, subid, DX) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  ungroup() %>%
  group_by(YeoNet, subcort_ROI, DX) %>%
  do(tidy(t.test(.$netmean_ivertex, .$netmean_tvertex, paired = TRUE)))

net_means_byDX %>%
  ungroup() %>%
  mutate(sig = if_else(p.value < 0.005, '*', NA_character_) ) %>%
ggplot(aes(x = YeoNet, y = subcort_ROI, fill = statistic)) + 
  geom_tile(color = "black", na.rm = TRUE) +
  geom_point(aes(shape = sig), na.rm = TRUE) +
  scale_fill_gradient2() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ DX)
```

```{r}
results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid, DX, age) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  filter(age > 17, age < 51) %>%
  ggplot(aes(x = YeoNet, y=subcort_ROI, fill = netmean_ivertex)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  facet_wrap(~ DX)
```
```{r}
results_pheno %>%
  mutate(corr_diff = ivertex_corr - tvertex_corr,
         YeoNet = str_sub(PINT_ROI, 1,2)) %>%
  group_by(YeoNet, subcort_ROI, subid, DX, age) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(age > 17, age < 51) %>%
  ggplot(aes(x = YeoNet, y=subcort_ROI, fill = netmean_corZ)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-0.5,0.5)) +
  facet_wrap(vertex_type ~ DX)
```
```{r}
library(knitr)

DX_lm_model <- results_pheno %>%
  gather(vertex_type, corZ, ivertex_corr, tvertex_corr) %>%
  filter(age > 17, age < 51) %>%
  group_by(vertex_type, subcort_ROI, PINT_ROI) %>%
  do(tidy(lm(corZ ~ DX*Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, PINT_ROI, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

DX_lm_model %>% 
  filter(term %in% c("DXCtrl", "Sex2", "DXCtrl:Sex2")) %>%
  filter(p.value < 0.1) %>%
  kable()
```
```{r}
DX_lm_model <- results_pheno %>%
  gather(vertex_type, corZ, ivertex_corr, tvertex_corr) %>%
  filter(age > 17, age < 51) %>%
  group_by(vertex_type, subcort_ROI, PINT_ROI) %>%
  do(tidy(lm(corZ ~ DX*Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, PINT_ROI, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

DX_lm_model %>% 
  filter(term %in% c("DXCtrl", "Sex2")) %>%
  filter(p.value < 0.1) %>%
  kable()
```
```{r}
DX_lm_model <- results_pheno %>%
  group_by(YeoNet, subcort_ROI, hemisphere, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  group_by(vertex_type, hemisphere, subcort_ROI, YeoNet) %>%
  do(tidy(lm(netmean_corZ ~ DX*Sex + mean_fd_pt + poly(Age_std,2) + Edu_std + Site,.))) %>%
  select(vertex_type, subcort_ROI, YeoNet, hemisphere, term, statistic, p.value) %>%
  ungroup() %>%
  group_by(term) %>%
  mutate(p_FDR = p.adjust(p.value, method = "fdr")) %>%
  arrange(p.value)

kable(DX_lm_model %>% filter(term %in% c("DXCtrl", "Sex2", "DXCtrl:Sex2"), p.value < 0.06))
```
```{r}
0.05/24
```

```{r}
DX_lm_model %>%
  filter(term == "DXCtrl") %>%
ggplot(aes(x = YeoNet, y=subcort_ROI, fill = statistic)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-4.5,-4.5)) +
  facet_wrap(~ vertex_type + hemisphere, ncol = 4)
```
```{r}
DX_lm_model %>%
  filter(term == "Sex2") %>%
ggplot(aes(x = YeoNet, y=subcort_ROI, fill = statistic)) +
  geom_tile(color = "black") +
  scale_fill_gradient2(breaks = c(-4.5,-4.5)) +
  facet_wrap(~ vertex_type + hemisphere, ncol = 4)
```

```{r}
results_pheno %>%
  group_by(YeoNet, subcort_ROI, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(YeoNet == "DM", subcort_ROI == "Striatum_DM") %>%
  ggplot(aes(y = netmean_corZ, x = Sex, by = DX, color = DX)) + 
  geom_boxplot() +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~ vertex_type + Site)
```

```{r}
results_pheno %>%
  group_by(YeoNet, subcort_ROI, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(YeoNet == "VA", subcort_ROI == "Striatum_VA") %>%
  ggplot(aes(y = netmean_corZ, x = Sex, by = DX, color = DX)) + 
  geom_boxplot() +
  scale_color_brewer(palette = "Dark2") +
  facet_grid(Site ~ vertex_type)
```

```{r fig.height=8, fig.width=4}
results_pheno %>%
  group_by(YeoNet, subcort_ROI, hemisphere, 
           subid, DX, Age_std, Sex, Site, Edu_std, mean_fd_pt) %>%
  summarise(netmean_ivertex = mean(ivertex_corr),
            netmean_tvertex = mean(tvertex_corr)) %>%
  gather(vertex_type, netmean_corZ, netmean_ivertex, netmean_tvertex) %>%
  filter(YeoNet == "VA", subcort_ROI == "Striatum_VA") %>%
  ggplot(aes(y = netmean_corZ, x = Sex, by = DX, color = DX)) + 
  geom_boxplot() +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~ Site + vertex_type + hemisphere)
```